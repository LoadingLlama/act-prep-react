<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Score Breakdown - ACT Prep</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            color: #2d3748;
            line-height: 1.5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 400;
            color: #1a1a1a;
            margin: 0;
        }

        .completion-badge {
            background: #10b981;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            display: inline-block;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .main-dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .dashboard-left {
            display: grid;
            grid-template-rows: auto auto auto 1fr;
            gap: 1rem;
        }

        .dashboard-right {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: fit-content;
        }

        .top-summary {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .section-scores {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .charts-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }

        .chart {
            margin-bottom: 1rem;
        }

        .chart:last-child {
            margin-bottom: 0;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .progress-chart {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .chart-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #718096;
        }

        .chart-item {
            margin-bottom: 0.75rem;
        }

        .chart-item:last-child {
            margin-bottom: 0;
        }

        .section-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .section-card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-card.selected {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .section-graph {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
        }

        .line-graph-container {
            background: #f8fafc;
            border-radius: 6px;
            padding: 0.75rem;
            height: 160px;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .graph-title {
            font-size: 0.8rem;
            color: #4b5563;
            margin-bottom: 0.5rem;
            text-align: center;
            font-weight: 500;
        }

        .line-graph {
            width: 100%;
            height: 120px;
            position: relative;
        }

        .graph-svg {
            width: 100%;
            height: 100%;
        }

        .grid-line {
            stroke: #f1f5f9;
            stroke-width: 1;
        }

        .axis-line {
            stroke: #d1d5db;
            stroke-width: 2;
        }

        .data-line {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .data-point {
            fill: white;
            stroke-width: 3;
            r: 5;
            transition: r 0.2s ease;
        }

        .data-point:hover {
            r: 7;
        }

        .axis-label {
            font-size: 12px;
            fill: #6b7280;
            text-anchor: middle;
        }

        .y-axis-label {
            text-anchor: end;
        }

        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .legend-color {
            width: 12px;
            height: 2px;
            border-radius: 1px;
        }

        .section-name {
            font-size: 0.7rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .act-score {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.1rem;
        }

        .score-range {
            font-size: 0.6rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }

        .accuracy {
            font-size: 0.7rem;
            font-weight: 500;
            color: #10b981;
        }

        .composite-score {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            min-width: 140px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .composite-score:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }

        .composite-score.selected {
            border-color: #3b82f6;
            background: #f0f9ff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .composite-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .composite-value {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.1rem;
        }

        .composite-range {
            font-size: 0.7rem;
            color: #9ca3af;
        }

        .nav-tabs {
            display: flex;
            background: transparent;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .nav-tab {
            padding: 0.5rem 0;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .nav-tab.active {
            color: #1a1a1a;
            border-bottom-color: #1a1a1a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.1rem;
        }

        .stat-value.correct { color: #10b981; }
        .stat-value.incorrect { color: #ef4444; }
        .stat-value.time { color: #6366f1; }
        .stat-value.total { color: #1a1a1a; }

        .stat-label {
            font-size: 0.65rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .topic-analytics {
            background: transparent;
            padding: 0;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            color: #1a1a1a;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 0.75rem;
        }

        .topic-card {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .topic-card:hover {
            border-color: #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .topic-header {
            padding: 0.75rem;
            background: transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .topic-name {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.9rem;
        }

        .topic-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .topic-score {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .topic-score.high { color: #10b981; }
        .topic-score.medium { color: #f59e0b; }
        .topic-score.low { color: #ef4444; }

        .expand-icon {
            font-size: 0.8rem;
            color: #666;
            transition: transform 0.2s ease;
        }

        .topic-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .topic-details {
            display: none;
            padding: 0 0.75rem 0.75rem 0.75rem;
            background: white;
        }

        .topic-card.expanded .topic-details {
            display: block;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .question-bubble {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .question-bubble.correct {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #bbf7d0;
        }

        .question-bubble.incorrect {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #fecaca;
        }

        .question-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .topic-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .topic-stat-item {
            text-align: center;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
        }

        .topic-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.2rem;
        }

        .topic-stat-label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .question-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .question-detail-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .question-status-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .passage-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .passage-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .passage-content {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #4b5563;
            margin-bottom: 1rem;
        }

        .question-text {
            background: #fff3cd;
            border: 1px solid #ffecb3;
            border-radius: 6px;
            padding: 1rem;
            font-style: italic;
            color: #6b4423;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .answer-option {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
        }

        .answer-option.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .answer-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .answer-option.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .recommendation-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .recommendation-box.success {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .recommendation-box.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .recommendation-text {
            margin: 0;
            line-height: 1.5;
        }

        .view-passage-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }

        .view-passage-btn:hover {
            background: #2563eb;
        }

        .underlined-highlight {
            background: #fef3c7;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            font-weight: 500;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2rem auto;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-body {
            padding: 2rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .answer-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .answer-box {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .correct-answer {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .your-answer {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .your-answer.correct {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .time-spent {
            background: #f0f9ff;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-top: 1rem;
        }

        .recommendations {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .recommendation-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.8);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: white;
            color: #1a1a1a;
            border: 1px solid #e5e7eb;
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .top-summary {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .section-scores {
                grid-template-columns: repeat(2, 1fr);
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-tabs {
                flex-direction: column;
            }

            .actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <h3>Analyzing Your Performance...</h3>
        <p>Calculating detailed results</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>ACT Score Breakdown</h1>
            <div class="completion-badge" id="completionBadge">
                Test Complete
            </div>
        </div>

        <!-- Dashboard Layout -->
        <div class="dashboard-layout">
            <!-- Left Panel: Scores and Stats -->
            <div class="dashboard-left">
                <!-- Top Summary -->
                <div class="top-summary">
                    <div class="composite-score selected" onclick="selectSection('all')" style="cursor: pointer;">
                        <div class="composite-label">Composite</div>
                        <div class="composite-value" id="compositeScore">--</div>
                        <div class="composite-range">1-36</div>
                    </div>

                    <!-- Section Scores -->
                    <div class="section-scores">
                        <div class="section-card" data-section="english" onclick="selectSection('english')">
                            <div class="section-name">English</div>
                            <div class="act-score" id="englishScore">--</div>
                            <div class="accuracy" id="englishAccuracy">--</div>
                        </div>
                        <div class="section-card" data-section="math" onclick="selectSection('math')">
                            <div class="section-name">Math</div>
                            <div class="act-score" id="mathScore">--</div>
                            <div class="accuracy" id="mathAccuracy">--</div>
                        </div>
                        <div class="section-card" data-section="reading" onclick="selectSection('reading')">
                            <div class="section-name">Reading</div>
                            <div class="act-score" id="readingScore">--</div>
                            <div class="accuracy" id="readingAccuracy">--</div>
                        </div>
                        <div class="section-card" data-section="science" onclick="selectSection('science')">
                            <div class="section-name">Science</div>
                            <div class="act-score" id="scienceScore">--</div>
                            <div class="accuracy" id="scienceAccuracy">--</div>
                        </div>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value total" id="totalCorrect">--</div>
                        <div class="stat-label">Total Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value correct" id="correctCount">--</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value time" id="totalTime">--</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value time" id="avgTime">--</div>
                        <div class="stat-label">Avg Per Q</div>
                    </div>
                </div>

                <!-- Navigation tabs moved outside dashboard layout -->
            </div>

            <!-- Right Panel: Graphs -->
            <div class="dashboard-right">
                <!-- Default Performance Graphs -->
                <div id="defaultGraphs" class="section-graph">
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 100%; max-width: 500px;">
                            <div class="graph-title" style="text-align: center; margin-bottom: 1rem;">Time per Question</div>
                            <div style="background: none; border: none; padding: 0;">
                                <svg class="graph-svg" viewBox="0 0 400 120" id="defaultTimeGraph" style="background: transparent; border: none;">
                                    <!-- Will be populated by JavaScript -->
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Performance Graph -->
                <div id="sectionGraph" class="section-graph" style="display: none;">
                    <div id="sectionGraphContent">
                        <!-- Graph content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="topics">By Topic</button>
            <button class="nav-tab" data-tab="questions">All Questions</button>
        </div>


        <!-- Topics Tab -->
        <div id="topics" class="tab-content active">
            <div class="topic-analytics">
                <h3 class="section-title">Performance by Topic</h3>
                <div class="topic-grid" id="topicGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- All Questions Tab -->
        <div id="questions" class="tab-content">
            <div class="topic-analytics">
                <h3 class="section-title">Question Review</h3>
                <div class="question-grid" id="allQuestionsGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="actions">
            <a href="index.html?tab=lessons" class="btn btn-primary">Study Weak Areas</a>
            <a href="diagnostic-test.html" class="btn btn-outline">Retake Diagnostic</a>
            <a href="math-test.html" class="btn btn-outline">Take Math Test</a>
            <a href="reading-test.html" class="btn btn-outline">Take Reading Test</a>
            <a href="science-test.html" class="btn btn-outline">Take Science Test</a>
            <a href="index.html" class="btn btn-outline">Dashboard</a>
        </div>
    </div>

    <!-- Question Detail Modal -->
    <div class="question-detail-modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Question Details</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Chapter configuration - easily reorderable and updatable
        const chapters = [
            { id: 'sentence-structure', name: 'Sentence Structure', description: 'Proper sentence construction and clarity' },
            { id: 'commas', name: 'Comma Usage', description: 'Correct comma placement and rules' },
            { id: 'word-choice', name: 'Word Choice', description: 'Selecting the most appropriate words' },
            { id: 'transitions', name: 'Transitions', description: 'Connecting ideas smoothly' },
            { id: 'pronouns', name: 'Pronouns', description: 'Pronoun-antecedent agreement' },
            { id: 'redundancy', name: 'Redundancy', description: 'Eliminating unnecessary repetition' },
            { id: 'modifiers', name: 'Modifiers', description: 'Proper placement of descriptive words' },
            { id: 'verbs', name: 'Verb Agreement', description: 'Subject-verb agreement and tense' },
            { id: 'punctuation', name: 'Punctuation', description: 'Proper use of punctuation marks' },
            { id: 'which-choice', name: 'Which Choice Questions', description: 'Rhetorical skills questions' },
            { id: 'adding-deleting', name: 'Adding/Deleting Info', description: 'Determining relevant information' },
            { id: 'logical-placement', name: 'Logical Placement', description: 'Organizing ideas logically' },
            { id: 'parallel-structure', name: 'Parallel Structure', description: 'Maintaining consistent grammatical forms' }
        ];

        // Generate chapter names lookup from chapters array for backward compatibility
        const chapterNames = chapters.reduce((acc, chapter) => {
            acc[chapter.id] = chapter.name;
            return acc;
        }, {});

        // Correct answers - validated against actual test questions
        // Questions alternate between A,B,C,D and F,G,H,J formats (standard ACT pattern)
        const correctAnswers = {
            q1: 'C',  // "When" - correct transition for sentence start
            q2: 'B',  // "ingredients—such as manioc root" - proper em dash usage
            q3: 'A',  // "thrilled" - best conveys positive experience
            q4: 'F',  // "Still" - good transition to next paragraph
            q5: 'A',  // "tree dies once its" - correct possessive pronoun
            q6: 'F',  // "live to yield" - maintains formal tone
            q7: 'D',  // "knowledge of local plants," - least redundant
            q8: 'J',  // "centuries, using" - correct punctuation
            q9: 'B',  // "has enabled" - proper subject-verb agreement
            q10: 'G', // "understanding" - better word choice
            q11: 'B', // "author and dramatist, is" - correct punctuation
            q12: 'J', // "the abbey at Gandersheim, which was well known" - proper clause
            q13: 'C', // "allowed her to maintain" - clearer phrasing
            q14: 'H', // "In addition," - better transition
            q15: 'D', // Delete parenthetical - improves flow
            q16: 'J', // "highway onto a stretch of Route 66 that is" - clear construction
            q17: 'D', // Delete redundant phrase
            q18: 'H', // Keep descriptive clause - adds context
            q19: 'A', // "were installed" - correct passive voice
            q20: 'J', // "there are currently no plans to restore the strips" - completes thought
            q21: 'D', // "fade" - correct singular verb
            q22: 'F', // "who have" - correct pronoun reference
            q23: 'C', // "For now," - better transition
            q24: 'H', // Delete unnecessary phrase
            q25: 'D', // Better placement at paragraph end
            q26: 'G', // Delete parenthetical - implied by context
            q27: 'D', // "Displaying" - more direct
            q28: 'F', // "storage provides" - subject-verb agreement
            q29: 'A', // "between it" - correct pronoun reference
            q30: 'G', // "By contrast," - better transition
            q31: 'C', // "that" - avoid redundant pronoun
            q32: 'F', // Correct punctuation with comma
            q33: 'A', // "can—and should—be" - proper emphasis
            q34: 'H', // "When" - correct subordinating conjunction
            q35: 'A', // "is" - correct singular verb
            q36: 'G', // "enormous haystacks" - vivid imagery
            q37: 'B', // "then it squeezes" - correct sequence
            q38: 'G', // "together during cold Kalahari nights" - cleaner phrasing
            q39: 'D', // "its" - correct possessive
            q40: 'J', // "cooperate" - better word choice
            q41: 'A', // "dizzying mazes of lines" - maintains style
            q42: 'G', // "centuries-old" - correct hyphenation
            q43: 'D', // Delete - doesn't fit paragraph focus
            q44: 'H', // "most commonly worn as" - clearer construction
            q45: 'D', // Delete - redundant with following description
            q46: 'F', // "appliqué, in which" - correct punctuation
            q47: 'B', // "the fabric's surface" - clearer reference
            q48: 'F', // "store-bought" - appropriate contrast
            q49: 'D', // "Today, though," - better transition
            q50: 'H'  // "Through her teaching, Pang Xiong..." - stronger conclusion
        };

        // Question mappings with detailed analysis - easily maintainable and flexible
        const questionMappings = [
            { number: 1, chapter: 'sentence-structure', concept: 'Sentence beginnings and transitions', difficulty: 'medium' },
            { number: 2, chapter: 'punctuation', concept: 'Em dash usage with examples', difficulty: 'medium' },
            { number: 3, chapter: 'word-choice', concept: 'Selecting words that convey tone', difficulty: 'easy' },
            { number: 4, chapter: 'transitions', concept: 'Paragraph transitions', difficulty: 'medium' },
            { number: 5, chapter: 'pronouns', concept: 'Possessive pronoun agreement', difficulty: 'easy' },
            { number: 6, chapter: 'word-choice', concept: 'Maintaining appropriate tone', difficulty: 'medium' },
            { number: 7, chapter: 'redundancy', concept: 'Eliminating wordy expressions', difficulty: 'medium' },
            { number: 8, chapter: 'punctuation', concept: 'Comma placement with modifiers', difficulty: 'hard' },
            { number: 9, chapter: 'verbs', concept: 'Subject-verb agreement with singular subjects', difficulty: 'medium' },
            { number: 10, chapter: 'word-choice', concept: 'Precise vocabulary selection', difficulty: 'medium' },
            { number: 11, chapter: 'punctuation', concept: 'Comma usage with appositives', difficulty: 'medium' },
            { number: 12, chapter: 'sentence-structure', concept: 'Relative clause construction', difficulty: 'hard' },
            { number: 13, chapter: 'word-choice', concept: 'Clear and concise expression', difficulty: 'medium' },
            { number: 14, chapter: 'transitions', concept: 'Logical connectors between ideas', difficulty: 'medium' },
            { number: 15, chapter: 'adding-deleting', concept: 'Relevance of parenthetical information', difficulty: 'medium' },
            { number: 16, chapter: 'sentence-structure', concept: 'Complex sentence construction', difficulty: 'hard' },
            { number: 17, chapter: 'redundancy', concept: 'Eliminating repetitive phrases', difficulty: 'easy' },
            { number: 18, chapter: 'adding-deleting', concept: 'Value of descriptive details', difficulty: 'medium' },
            { number: 19, chapter: 'verbs', concept: 'Passive voice construction', difficulty: 'medium' },
            { number: 20, chapter: 'adding-deleting', concept: 'Completing thoughts and ideas', difficulty: 'medium' },
            { number: 21, chapter: 'verbs', concept: 'Subject-verb agreement with collective nouns', difficulty: 'medium' },
            { number: 22, chapter: 'pronouns', concept: 'Relative pronoun usage', difficulty: 'easy' },
            { number: 23, chapter: 'transitions', concept: 'Temporal transitions', difficulty: 'medium' },
            { number: 24, chapter: 'adding-deleting', concept: 'Unnecessary information', difficulty: 'easy' },
            { number: 25, chapter: 'logical-placement', concept: 'Sentence placement for flow', difficulty: 'hard' },
            { number: 26, chapter: 'adding-deleting', concept: 'Implied vs. explicit information', difficulty: 'medium' },
            { number: 27, chapter: 'word-choice', concept: 'Active vs. passive construction', difficulty: 'medium' },
            { number: 28, chapter: 'verbs', concept: 'Subject-verb agreement with compound subjects', difficulty: 'easy' },
            { number: 29, chapter: 'pronouns', concept: 'Pronoun reference clarity', difficulty: 'medium' },
            { number: 30, chapter: 'transitions', concept: 'Contrasting transitions', difficulty: 'medium' },
            { number: 31, chapter: 'redundancy', concept: 'Avoiding redundant pronouns', difficulty: 'medium' },
            { number: 32, chapter: 'punctuation', concept: 'Comma usage in complex sentences', difficulty: 'easy' },
            { number: 33, chapter: 'adding-deleting', concept: 'Essential vs. nonessential information', difficulty: 'medium' },
            { number: 34, chapter: 'transitions', concept: 'Subordinating conjunctions', difficulty: 'hard' },
            { number: 35, chapter: 'verbs', concept: 'Subject-verb agreement with singular collective nouns', difficulty: 'easy' },
            { number: 36, chapter: 'word-choice', concept: 'Descriptive language and imagery', difficulty: 'medium' },
            { number: 37, chapter: 'sentence-structure', concept: 'Coordinating clauses', difficulty: 'medium' },
            { number: 38, chapter: 'redundancy', concept: 'Eliminating wordy constructions', difficulty: 'medium' },
            { number: 39, chapter: 'pronouns', concept: 'Possessive pronoun clarity', difficulty: 'easy' },
            { number: 40, chapter: 'word-choice', concept: 'Precise verb selection', difficulty: 'medium' },
            { number: 41, chapter: 'parallel-structure', concept: 'Maintaining parallelism in lists', difficulty: 'medium' },
            { number: 42, chapter: 'punctuation', concept: 'Hyphenation of compound adjectives', difficulty: 'medium' },
            { number: 43, chapter: 'adding-deleting', concept: 'Relevance to paragraph focus', difficulty: 'hard' },
            { number: 44, chapter: 'word-choice', concept: 'Clear and natural phrasing', difficulty: 'medium' },
            { number: 45, chapter: 'redundancy', concept: 'Removing redundant descriptions', difficulty: 'medium' },
            { number: 46, chapter: 'punctuation', concept: 'Comma usage with relative clauses', difficulty: 'easy' },
            { number: 47, chapter: 'pronouns', concept: 'Clear pronoun reference', difficulty: 'medium' },
            { number: 48, chapter: 'word-choice', concept: 'Appropriate vocabulary level', difficulty: 'easy' },
            { number: 49, chapter: 'transitions', concept: 'Transitional phrases', difficulty: 'medium' },
            { number: 50, chapter: 'sentence-structure', concept: 'Effective conclusion construction', difficulty: 'hard' }
        ];

        // Generate backward-compatible questionChapters object
        const questionChapters = questionMappings.reduce((acc, mapping) => {
            acc[mapping.number] = mapping.chapter;
            return acc;
        }, {});

        let testResults = {};
        let questionResults = {};

        // ACT score conversion tables (based on number correct out of 50 questions)
        const actScoreConversion = {
            50: 36, 49: 35, 48: 34, 47: 33, 46: 32, 45: 31, 44: 30, 43: 29, 42: 28, 41: 27,
            40: 26, 39: 25, 38: 24, 37: 23, 36: 22, 35: 21, 34: 20, 33: 19, 32: 18, 31: 17,
            30: 16, 29: 15, 28: 14, 27: 13, 26: 12, 25: 11, 24: 10, 23: 9, 22: 8, 21: 7,
            20: 6, 19: 5, 18: 4, 17: 3, 16: 2, 15: 1, 14: 1, 13: 1, 12: 1, 11: 1,
            10: 1, 9: 1, 8: 1, 7: 1, 6: 1, 5: 1, 4: 1, 3: 1, 2: 1, 1: 1, 0: 1
        };

        function formatTime(ms) {
            if (!ms || ms === 0) return '0s';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            }
            return `${seconds}s`;
        }

        function getScoreLevel(percentage) {
            return percentage >= 75 ? 'high' : percentage >= 50 ? 'medium' : 'low';
        }

        // Helper function to convert simple answer format to expected results format
        function convertAnswersToResultsFormat(answersData, section = 'english') {
            if (!answersData) return null;

            const results = { answers: {}, timeSpentPerQuestion: {} };

            // Get correct answers for the appropriate section
            const sectionCorrectAnswers = getCorrectAnswersForSection(section);

            Object.keys(answersData).forEach(questionKey => {
                const userAnswer = answersData[questionKey];
                const correctAnswer = sectionCorrectAnswers[questionKey];
                const isCorrect = userAnswer && correctAnswer && userAnswer.toLowerCase() === correctAnswer.toLowerCase();

                results.answers[questionKey] = {
                    answer: userAnswer,
                    isCorrect: isCorrect,
                    timeSpent: 60 // Default time since we don't track it yet
                };
                results.timeSpentPerQuestion[questionKey] = 60;
            });

            return results;
        }

        // Get correct answers for each section
        function getCorrectAnswersForSection(section) {
            // English correct answers (already defined in the code)
            const englishCorrectAnswers = {
                q1: 'C',  q2: 'B',  q3: 'A',  q4: 'F',  q5: 'A',  q6: 'F',  q7: 'D',  q8: 'J',  q9: 'B',  q10: 'G',
                q11: 'B', q12: 'J', q13: 'C', q14: 'H', q15: 'D', q16: 'J', q17: 'D', q18: 'H', q19: 'A', q20: 'J',
                q21: 'D', q22: 'F', q23: 'C', q24: 'H', q25: 'D', q26: 'G', q27: 'D', q28: 'F', q29: 'A', q30: 'G',
                q31: 'C', q32: 'F', q33: 'A', q34: 'H', q35: 'A', q36: 'G', q37: 'B', q38: 'G', q39: 'D', q40: 'J',
                q41: 'A', q42: 'G', q43: 'D', q44: 'H', q45: 'D', q46: 'F', q47: 'B', q48: 'F', q49: 'D', q50: 'H'
            };

            // For now, other sections don't have defined correct answers yet
            // This can be expanded when correct answers are available
            const mathCorrectAnswers = {}; // TODO: Add math correct answers
            const readingCorrectAnswers = {}; // TODO: Add reading correct answers
            const scienceCorrectAnswers = {}; // TODO: Add science correct answers

            switch(section) {
                case 'english': return englishCorrectAnswers;
                case 'math': return mathCorrectAnswers;
                case 'reading': return readingCorrectAnswers;
                case 'science': return scienceCorrectAnswers;
                default: return {};
            }
        }

        // Question content database - includes passages, questions, and answer choices
        function getQuestionContent(questionNum) {
            const englishQuestions = {
                1: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "At first, Brazilian chef Alex Atala opened his restaurant in São Paulo in 1999, people told him he'd never succeed.",
                    underlined: "At first",
                    question: "Which choice makes the sentence most grammatically acceptable?",
                    choices: { A: "At first", B: "Initially", C: "When", D: "DELETE the underlined portion" }
                },
                2: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Using traditional Brazilian ingredients, such as, manioc root and even ants—in innovative ways, he has thrilled diners from around the world.",
                    underlined: "such as, manioc root",
                    question: "Which choice makes the sentence most grammatically acceptable?",
                    choices: { A: "NO CHANGE", B: "such as manioc root", C: "such as: manioc root", D: "such as; manioc root" }
                },
                3: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Using traditional Brazilian ingredients in innovative ways, he has thrilled diners from around the world.",
                    underlined: "thrilled",
                    question: "Which choice best conveys the positive experience of diners?",
                    choices: { A: "thrilled", B: "satisfied", C: "fed", D: "served" }
                },
                4: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Still, Atala felt he could do more for his country and its cuisine.",
                    underlined: "Still",
                    question: "Which transition word best connects this paragraph to the previous one?",
                    choices: { F: "Still", G: "However", H: "Therefore", J: "Moreover" }
                },
                5: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Needing eight years to mature, the tree dies once its large heart is removed.",
                    underlined: "tree dies once its",
                    question: "Which choice correctly uses the possessive pronoun?",
                    choices: { A: "tree dies once its", B: "tree dies once it's", C: "tree dies once their", D: "tree dies once there" }
                },
                6: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Careful harvesting ensures that the tree will live to yield more hearts, resulting in environmentally friendly production.",
                    underlined: "live to yield",
                    question: "Which choice maintains the formal tone of the passage?",
                    choices: { F: "live to yield", G: "survive to give", H: "stay alive to make", J: "keep going to produce" }
                },
                7: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Utilizing their historical know-how they have, he aims to bolster tribe members' livelihoods.",
                    underlined: "know-how they have",
                    question: "Which choice is the least redundant?",
                    choices: { A: "NO CHANGE", B: "know-how", C: "knowledge that they have", D: "knowledge of local plants," }
                },
                8: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "For instance, Baniwa women have farmed distinctly flavorful chili peppers for centuries that use indigenous agricultural techniques.",
                    underlined: "centuries that use",
                    question: "Which choice provides the clearest meaning?",
                    choices: { F: "NO CHANGE", G: "centuries, and use", H: "centuries, they use", J: "centuries, using" }
                },
                9: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Partnering with Instituto Atá have enabled these women from a remote rain forest region to scale up production.",
                    underlined: "have enabled",
                    question: "Which choice shows proper subject-verb agreement?",
                    choices: { A: "NO CHANGE", B: "has enabled", C: "are enabling", D: "were enabling" }
                },
                10: {
                    passage: "Alex Atala and Brazilian Cuisine",
                    context: "Expanding awareness of the rich diversity of Brazil's native ingredients, Atala continues to lead in deciphering the country's food culture.",
                    underlined: "deciphering",
                    question: "Which choice provides the most precise word?",
                    choices: { F: "deciphering", G: "understanding", H: "figuring out", J: "solving" }
                }
                // More questions can be added for complete coverage...
            };

            return englishQuestions[questionNum] || {
                passage: "Question Content",
                context: "Question content not available for this question.",
                underlined: "",
                question: "Question text not available.",
                choices: { A: "Option A", B: "Option B", C: "Option C", D: "Option D" }
            };
        }

        function calculateResults() {
            // Get results from all test sections with error handling
            let diagnosticResults, mathResults, readingResults, scienceResults;

            try {
                // Check for actual keys that tests save
                const englishAnswers = JSON.parse(localStorage.getItem('englishAnswers') || 'null');
                const mathAnswers = JSON.parse(localStorage.getItem('mathAnswers') || 'null');
                const readingAnswers = JSON.parse(localStorage.getItem('readingAnswers') || 'null');
                scienceResults = JSON.parse(localStorage.getItem('scienceAnswers') || 'null');

                console.log('Found test data:');
                console.log('English:', englishAnswers);
                console.log('Math:', mathAnswers);
                console.log('Reading:', readingAnswers);
                console.log('Science:', scienceResults);

                // Convert all answers to expected format
                diagnosticResults = convertAnswersToResultsFormat(englishAnswers, 'english');
                mathResults = convertAnswersToResultsFormat(mathAnswers, 'math');
                readingResults = convertAnswersToResultsFormat(readingAnswers, 'reading');
                scienceResults = convertAnswersToResultsFormat(scienceResults, 'science');
            } catch (error) {
                console.error('Error parsing test results:', error);
                // Continue with null values - will show 0 scores
                diagnosticResults = null;
                mathResults = null;
                readingResults = null;
                scienceResults = null;
            }

            // Use diagnosticResults (English) as primary, or create empty structure if no data
            const results = diagnosticResults || { answers: {}, timeSpentPerQuestion: {} };

            testResults = results;
            const { answers, timeSpentPerQuestion } = results;

            let correctCount = 0;
            const chapterStats = {};
            questionResults = {};

            // Calculate scores for all sections
            const sectionScores = {
                english: calculateSectionScore(diagnosticResults, 50),
                math: calculateSectionScore(mathResults, 50),
                reading: calculateSectionScore(readingResults, 50),
                science: calculateSectionScore(scienceResults, 50)
            };
            
            // Process each question with enhanced analytics
            const difficultyStats = { easy: {correct: 0, total: 0}, medium: {correct: 0, total: 0}, hard: {correct: 0, total: 0} };

            for (let i = 1; i <= 50; i++) {
                const questionKey = `q${i}`;
                const userAnswer = answers[questionKey];
                const correctAnswer = correctAnswers[questionKey];
                const timeKey = `q${i}`;
                const timeSpent = timeSpentPerQuestion[timeKey] || 0;
                const mapping = questionMappings.find(m => m.number === i);
                const chapter = mapping ? mapping.chapter : questionChapters[i];
                const difficulty = mapping ? mapping.difficulty : 'medium';
                const concept = mapping ? mapping.concept : '';
                const isCorrect = userAnswer?.isCorrect !== undefined ? userAnswer.isCorrect : (userAnswer?.answer === correctAnswer);

                if (isCorrect) correctCount++;

                // Update difficulty stats
                difficultyStats[difficulty].total++;
                if (isCorrect) difficultyStats[difficulty].correct++;

                // Store individual question result with enhanced data
                questionResults[i] = {
                    userAnswer: userAnswer?.answer || 'No Answer',
                    correctAnswer: correctAnswer,
                    isCorrect: isCorrect,
                    timeSpent: timeSpent,
                    chapter: chapter,
                    difficulty: difficulty,
                    concept: concept
                };

                // Update chapter stats with enhanced tracking
                if (!chapterStats[chapter]) {
                    chapterStats[chapter] = {
                        total: 0,
                        correct: 0,
                        totalTime: 0,
                        questions: [],
                        avgTime: 0,
                        difficulty: { easy: 0, medium: 0, hard: 0 },
                        difficultyCorrect: { easy: 0, medium: 0, hard: 0 }
                    };
                }

                chapterStats[chapter].total++;
                if (isCorrect) chapterStats[chapter].correct++;
                chapterStats[chapter].totalTime += timeSpent;
                chapterStats[chapter].questions.push(i);
                chapterStats[chapter].difficulty[difficulty]++;
                if (isCorrect) chapterStats[chapter].difficultyCorrect[difficulty]++;
            }

            // Calculate average times and difficulty analysis
            Object.keys(chapterStats).forEach(chapter => {
                chapterStats[chapter].avgTime = chapterStats[chapter].totalTime / chapterStats[chapter].total;
            });

            // Calculate total time spent
            const totalTimeSpent = Object.values(timeSpentPerQuestion).reduce((sum, time) => sum + time, 0);
            const overallAccuracy = Math.round((correctCount / 50) * 100);
            const avgTimePerQuestion = totalTimeSpent / 50;

            // Update overview with all sections
            updateOverview(correctCount, overallAccuracy, totalTimeSpent, avgTimePerQuestion, sectionScores);

            // Assign local chapterStats to global variable for later use
            window.chapterStats = chapterStats;

            // Don't update topics here - let selectSection('all') handle it during initialization
            // updateTopics(chapterStats); // Removed to prevent showing English topics on page load

            // Update all questions view
            updateAllQuestions();

            // Generate enhanced recommendations
            generateRecommendations(chapterStats, overallAccuracy, totalTimeSpent, difficultyStats);
        }

        function calculateSectionScore(sectionResults, totalQuestions) {
            if (!sectionResults || !sectionResults.answers) {
                return { correct: 0, actScore: 1, accuracy: 0 };
            }

            let correct = 0;
            const answers = sectionResults.answers;

            for (let i = 1; i <= totalQuestions; i++) {
                const questionKey = `q${i}`;
                const userAnswer = answers[questionKey];
                const correctAnswer = correctAnswers[questionKey];

                if (userAnswer?.isCorrect !== undefined ? userAnswer.isCorrect : (userAnswer?.answer === correctAnswer)) {
                    correct++;
                }
            }

            const actScore = actScoreConversion[correct] || 1;
            const accuracy = Math.round((correct / totalQuestions) * 100);

            return { correct, actScore, accuracy };
        }

        function calculateCompositeScore(sectionScores) {
            const scores = [sectionScores.english.actScore, sectionScores.math.actScore,
                          sectionScores.reading.actScore, sectionScores.science.actScore];
            const validScores = scores.filter(score => score > 1);

            if (validScores.length === 0) return 1;

            const sum = validScores.reduce((a, b) => a + b, 0);
            return Math.round(sum / validScores.length);
        }

        function updateOverview(correctCount, accuracy, totalTime, avgTime, sectionScores) {
            // Calculate composite score
            const compositeScore = calculateCompositeScore(sectionScores);
            document.getElementById('compositeScore').textContent = compositeScore;

            // Update section scores
            document.getElementById('englishScore').textContent = sectionScores.english.actScore;
            document.getElementById('englishAccuracy').textContent = `${sectionScores.english.correct}/50`;

            document.getElementById('mathScore').textContent = sectionScores.math.actScore;
            document.getElementById('mathAccuracy').textContent = `${sectionScores.math.correct}/50`;

            document.getElementById('readingScore').textContent = sectionScores.reading.actScore;
            document.getElementById('readingAccuracy').textContent = `${sectionScores.reading.correct}/50`;

            document.getElementById('scienceScore').textContent = sectionScores.science.actScore;
            document.getElementById('scienceAccuracy').textContent = `${sectionScores.science.correct}/50`;

            // Update summary stats
            document.getElementById('totalCorrect').textContent = `${correctCount}/50`;
            document.getElementById('correctCount').textContent = `${accuracy}%`;
            document.getElementById('totalTime').textContent = formatTime(totalTime);
            document.getElementById('avgTime').textContent = formatTime(avgTime);
        }

        function getPerformanceLevel(accuracy) {
            if (accuracy >= 90) return 'Excellent Performance';
            if (accuracy >= 75) return 'Good Performance';
            if (accuracy >= 60) return 'Fair Performance';
            return 'Needs Improvement';
        }

        function updateTopics(chapterStats) {
            const topicGrid = document.getElementById('topicGrid');
            const topics = Object.entries(chapterStats)
                .map(([chapter, stats]) => ({
                    chapter,
                    name: chapterNames[chapter] || chapter,
                    accuracy: Math.round((stats.correct / stats.total) * 100),
                    correct: stats.correct,
                    total: stats.total,
                    avgTime: formatTime(stats.totalTime / stats.total),
                    questions: stats.questions
                }))
                .sort((a, b) => b.accuracy - a.accuracy);

            topicGrid.innerHTML = topics.map(topic => `
                <div class="topic-card" data-chapter="${topic.chapter}">
                    <div class="topic-header" onclick="toggleTopic('${topic.chapter}')">
                        <div class="topic-name">${topic.name}</div>
                        <div class="topic-summary">
                            <span class="topic-score ${getScoreLevel(topic.accuracy)}">${topic.accuracy}% (${topic.correct}/${topic.total})</span>
                            <span class="expand-icon">▼</span>
                        </div>
                    </div>
                    <div class="topic-details">
                        <div class="question-grid">
                            ${topic.questions.map(qNum => `
                                <div class="question-bubble ${questionResults[qNum].isCorrect ? 'correct' : 'incorrect'}" 
                                     onclick="showQuestionDetail(${qNum})">
                                    ${qNum}
                                </div>
                            `).join('')}
                        </div>
                        <div class="topic-stats">
                            <div class="topic-stat-item">
                                <div class="topic-stat-value">${topic.accuracy}%</div>
                                <div class="topic-stat-label">Accuracy</div>
                            </div>
                            <div class="topic-stat-item">
                                <div class="topic-stat-value">${topic.correct}/${topic.total}</div>
                                <div class="topic-stat-label">Correct</div>
                            </div>
                            <div class="topic-stat-item">
                                <div class="topic-stat-value">${topic.avgTime}</div>
                                <div class="topic-stat-label">Avg Time</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAllQuestions() {
            const questionsGrid = document.getElementById('allQuestionsGrid');
            questionsGrid.innerHTML = '';
            
            for (let i = 1; i <= 50; i++) {
                const result = questionResults[i];
                const bubble = document.createElement('div');
                bubble.className = `question-bubble ${result.isCorrect ? 'correct' : 'incorrect'}`;
                bubble.textContent = i;
                bubble.onclick = () => showQuestionDetail(i);
                questionsGrid.appendChild(bubble);
            }
        }

        function generateRecommendations(chapterStats, accuracy, totalTime, difficultyStats) {
            const recommendations = [];

            // Difficulty-based analysis
            const easyAccuracy = difficultyStats.easy.total > 0 ? (difficultyStats.easy.correct / difficultyStats.easy.total) * 100 : 0;
            const mediumAccuracy = difficultyStats.medium.total > 0 ? (difficultyStats.medium.correct / difficultyStats.medium.total) * 100 : 0;
            const hardAccuracy = difficultyStats.hard.total > 0 ? (difficultyStats.hard.correct / difficultyStats.hard.total) * 100 : 0;

            // Find weakest topics with enhanced analysis
            const weakTopics = Object.entries(chapterStats)
                .filter(([chapter, stats]) => (stats.correct / stats.total) < 0.7)
                .sort((a, b) => (a[1].correct / a[1].total) - (b[1].correct / b[1].total))
                .slice(0, 3);

            // Priority recommendations based on difficulty performance
            if (easyAccuracy < 85 && difficultyStats.easy.total > 0) {
                recommendations.push({
                    type: 'critical',
                    text: `🚨 Master the basics first: ${Math.round(easyAccuracy)}% on easy questions. Focus on fundamental grammar rules.`
                });
            }

            if (weakTopics.length > 0) {
                const weakest = weakTopics[0];
                const accuracy = Math.round((weakest[1].correct / weakest[1].total) * 100);
                recommendations.push({
                    type: 'important',
                    text: `📚 Priority study area: ${chapterNames[weakest[0]]} (${accuracy}% accuracy, ${weakest[1].total} questions)`
                });
            }

            // Time management insights
            const avgTimePerQ = totalTime / 50;
            const timePerQuestion = avgTimePerQ / 1000; // Convert to seconds

            if (timePerQuestion > 50) {
                recommendations.push({
                    type: 'timing',
                    text: `⏱️ Improve pacing: You spent ${Math.round(timePerQuestion)}s per question. Target 42s for optimal timing.`
                });
            } else if (timePerQuestion < 30 && accuracy < 75) {
                recommendations.push({
                    type: 'accuracy',
                    text: `🎯 Slow down for accuracy: Quick pace (${Math.round(timePerQuestion)}s/question) but ${accuracy}% accuracy. Take more time to read carefully.`
                });
            }

            // Difficulty progression recommendations
            if (easyAccuracy >= 90 && mediumAccuracy < 70) {
                recommendations.push({
                    type: 'progression',
                    text: `📈 Ready for medium difficulty: Strong on easy questions (${Math.round(easyAccuracy)}%). Practice medium-level concepts.`
                });
            }

            if (mediumAccuracy >= 80 && hardAccuracy < 60) {
                recommendations.push({
                    type: 'advanced',
                    text: `🎓 Challenge yourself: Solid medium performance (${Math.round(mediumAccuracy)}%). Start tackling hard questions.`
                });
            }

            // Overall performance insights
            if (accuracy >= 85) {
                recommendations.push({
                    type: 'excellent',
                    text: `🌟 Excellent work! ${accuracy}% accuracy puts you in the top tier. Fine-tune timing and tackle the hardest questions.`
                });
            } else if (accuracy >= 75) {
                recommendations.push({
                    type: 'good',
                    text: `✅ Solid performance at ${accuracy}%. Focus on your weak areas to reach the next level.`
                });
            } else if (accuracy >= 60) {
                recommendations.push({
                    type: 'developing',
                    text: `📖 Building skills at ${accuracy}%. Consistent practice on fundamentals will boost your score.`
                });
            } else {
                recommendations.push({
                    type: 'foundation',
                    text: `🔨 Build your foundation: ${accuracy}% indicates need for systematic grammar review. Start with basic concepts.`
                });
            }

            // Specific chapter recommendations for weak areas
            if (weakTopics.length > 1) {
                const secondWeak = weakTopics[1];
                const secondAccuracy = Math.round((secondWeak[1].correct / secondWeak[1].total) * 100);
                recommendations.push({
                    type: 'secondary',
                    text: `📝 Secondary focus: ${chapterNames[secondWeak[0]]} (${secondAccuracy}% accuracy)`
                });
            }

            // Generate HTML with styled recommendations
            const typeColors = {
                critical: '#ef4444',
                important: '#f59e0b',
                timing: '#3b82f6',
                accuracy: '#8b5cf6',
                progression: '#10b981',
                advanced: '#6366f1',
                excellent: '#059669',
                good: '#10b981',
                developing: '#f59e0b',
                foundation: '#ef4444',
                secondary: '#6b7280'
            };

            document.getElementById('recommendationsList').innerHTML = recommendations
                .map(rec => `
                    <div class="recommendation-item" style="border-left: 4px solid ${typeColors[rec.type]}; padding-left: 1rem; margin-bottom: 0.75rem;">
                        ${rec.text}
                    </div>
                `).join('');
        }

        function toggleTopic(chapter) {
            const card = document.querySelector(`[data-chapter="${chapter}"]`);
            card.classList.toggle('expanded');
        }

        function showQuestionDetail(questionNum) {
            const result = questionResults[questionNum];
            const questionContent = getQuestionContent(questionNum);
            const modal = document.getElementById('questionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.innerHTML = `
                <span>Question ${questionNum} Analysis</span>
                <button class="view-passage-btn" onclick="viewFullPassage('${questionContent.passage}')">
                    📄 View Full Passage
                </button>
            `;

            const isCorrect = result.isCorrect;
            const statusClass = isCorrect ? 'correct' : 'incorrect';
            const statusText = isCorrect ? 'Correct' : 'Incorrect';
            const difficultyColor = result.difficulty === 'easy' ? '#10b981' : result.difficulty === 'medium' ? '#f59e0b' : '#ef4444';

            // Get all answer choices and mark correct/selected
            const answerChoicesHTML = Object.entries(questionContent.choices).map(([letter, text]) => {
                let className = 'answer-option';
                if (letter === result.correctAnswer) className += ' correct';
                if (letter === result.userAnswer && letter !== result.correctAnswer) className += ' incorrect';
                if (letter === result.userAnswer) className += ' selected';

                return `
                    <div class="${className}">
                        <strong>${letter}.</strong> ${text}
                        ${letter === result.correctAnswer ? '<span style="float: right; color: #10b981;">✓ Correct</span>' : ''}
                        ${letter === result.userAnswer && letter !== result.correctAnswer ? '<span style="float: right; color: #ef4444;">✗ Your Answer</span>' : ''}
                        ${letter === result.userAnswer && letter === result.correctAnswer ? '<span style="float: right; color: #10b981;">✓ Your Answer</span>' : ''}
                    </div>
                `;
            }).join('');

            modalBody.innerHTML = `
                <div class="question-status-header">
                    <div class="question-bubble ${statusClass}" style="display: inline-flex; width: 60px; height: 60px; font-size: 1.2rem; margin-bottom: 1rem;">
                        ${questionNum}
                    </div>
                    <h4 style="margin: 0.5rem 0; color: ${isCorrect ? '#166534' : '#dc2626'}; font-size: 1.3rem;">${statusText}</h4>
                    <div style="display: inline-block; padding: 0.4rem 1rem; border-radius: 1rem; background-color: ${difficultyColor}; color: white; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">
                        ${result.difficulty}
                    </div>
                </div>

                <div class="passage-section">
                    <div class="passage-title">
                        📖 ${questionContent.passage}
                        <span style="background: #e5e7eb; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; color: #6b7280;">Passage Context</span>
                    </div>
                    <div class="passage-content">
                        ${questionContent.context.replace(questionContent.underlined, `<span class="underlined-highlight">${questionContent.underlined}</span>`)}
                    </div>
                    <div class="question-text">
                        <strong>Question:</strong> ${questionContent.question}
                    </div>
                </div>

                <div style="margin: 1.5rem 0;">
                    <h5 style="margin-bottom: 1rem; color: #374151; font-size: 1.1rem;">Answer Choices</h5>
                    <div class="answer-grid">
                        ${answerChoicesHTML}
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Topic</div>
                        <div class="stat-value">${chapterNames[result.chapter] || result.chapter}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Concept</div>
                        <div class="stat-value">${result.concept}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Time Spent</div>
                        <div class="stat-value">${formatTime(result.timeSpent)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Difficulty</div>
                        <div class="stat-value">${result.difficulty.charAt(0).toUpperCase() + result.difficulty.slice(1)}</div>
                    </div>
                </div>

                <div class="recommendation-box ${isCorrect ? 'success' : 'error'}">
                    <div class="recommendation-title" style="color: ${isCorrect ? '#166534' : '#dc2626'};">
                        ${isCorrect ? '🎉 Excellent Work!' : '📚 Study Recommendation'}
                    </div>
                    <div class="recommendation-text" style="color: ${isCorrect ? '#14532d' : '#7f1d1d'};">
                        ${isCorrect
                            ? `You correctly identified this ${result.difficulty}-level ${chapterNames[result.chapter].toLowerCase()} concept. Great understanding of ${result.concept.toLowerCase()}!`
                            : `Focus on <strong>${chapterNames[result.chapter]}</strong> concepts, particularly ${result.concept.toLowerCase()}. Consider reviewing similar ${result.difficulty}-level questions and practicing passage analysis.`
                        }
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function viewFullPassage(passageName) {
            alert(`Feature coming soon: View full passage "${passageName}"\n\nThis will open the complete passage text in a new window for detailed review.`);
        }

        function closeModal() {
            document.getElementById('questionModal').classList.remove('active');
        }

        // Tab functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Close modal when clicking outside
        document.getElementById('questionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Section Selection Functions
        let selectedSection = null;
        let allSectionResults = {};
        let chapterStats = {};

        function selectSection(sectionName) {
            console.log(`selectSection called with: ${sectionName}`);
            selectedSection = sectionName;

            // Update visual selection
            document.querySelectorAll('.section-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Remove selected class from composite score
            document.querySelector('.composite-score').classList.remove('selected');

            if (sectionName !== 'all') {
                document.querySelector(`[data-section="${sectionName}"]`).classList.add('selected');
                console.log(`Selected section button for: ${sectionName}`);
            } else {
                // Add selected class to composite score when "all" is selected
                document.querySelector('.composite-score').classList.add('selected');
                console.log('Selected composite score button');
            }

            // Update topics and questions for selected section
            console.log(`About to update topics for section: ${sectionName}`);
            updateTopicsForSection(sectionName);
            updateQuestionsForSection(sectionName);

            // Show section details
            showSectionDetails(sectionName);

            console.log(`selectSection completed for: ${sectionName}`);
        }

        function showSectionDetails(sectionName) {
            const sectionGraph = document.getElementById('sectionGraph');
            const sectionTitle = document.getElementById('sectionGraphTitle');
            const sectionSubtitle = document.getElementById('sectionGraphSubtitle');

            // Update title
            if (sectionName === 'all') {
                sectionTitle.textContent = `Composite Performance`;
                sectionSubtitle.textContent = `Overall performance across all sections`;
            } else {
                sectionTitle.textContent = `${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} Performance`;
                sectionSubtitle.textContent = `Interactive performance visualization`;
            }

            // Get section data
            let sectionData;
            if (sectionName === 'all') {
                // Combine all section data for composite view
                const allData = Object.values(allSectionResults);
                sectionData = {
                    correct: allData.reduce((sum, section) => sum + section.correct, 0),
                    total: allData.reduce((sum, section) => sum + section.total, 0),
                    time: allData.reduce((sum, section) => sum + section.time, 0),
                    accuracy: 0 // Will be calculated below
                };
                sectionData.accuracy = sectionData.total > 0 ? (sectionData.correct / sectionData.total) * 100 : 0;
            } else {
                sectionData = allSectionResults[sectionName] || { correct: 0, total: 0, time: 0, accuracy: 0 };
            }
            const accuracy = sectionData.total > 0 ? (sectionData.correct / sectionData.total) * 100 : 0;
            const avgTime = sectionData.total > 0 ? sectionData.time / sectionData.total : 0;

            // Section color themes
            const sectionColors = {
                english: { primary: '#3b82f6', secondary: '#dbeafe' },
                math: { primary: '#10b981', secondary: '#d1fae5' },
                reading: { primary: '#f59e0b', secondary: '#fef3c7' },
                science: { primary: '#8b5cf6', secondary: '#ede9fe' }
            };

            const colors = sectionColors[sectionName] || sectionColors.english;

            // Create line graph showing time vs accuracy
            const graphContent = document.getElementById('sectionGraphContent');

            // Generate question-by-question data
            const { timeData, accuracyData } = generateQuestionData(sectionName, sectionData);

            graphContent.innerHTML = `
                <div style="height: 100%; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 100%; max-width: 500px;">
                        <div class="graph-title" style="text-align: center; margin-bottom: 1rem;">${sectionName === 'all' ? 'Composite' : sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} Time per Question</div>
                        <div style="background: none; border: none; padding: 0;">
                            <svg class="graph-svg" viewBox="0 0 400 120" style="background: transparent; border: none;">
                                <!-- Axes -->
                                <line x1="30" y1="100" x2="370" y2="100" class="axis-line"/>
                                <line x1="30" y1="100" x2="30" y2="10" class="axis-line"/>

                                <!-- Y-axis labels -->
                                <text x="25" y="15" class="axis-label y-axis-label" style="font-size: 8px;">120s</text>
                                <text x="25" y="55" class="axis-label y-axis-label" style="font-size: 8px;">60s</text>
                                <text x="25" y="95" class="axis-label y-axis-label" style="font-size: 8px;">0s</text>

                                <!-- X-axis labels -->
                                <text x="80" y="115" class="axis-label" style="font-size: 8px;">Q10</text>
                                <text x="150" y="115" class="axis-label" style="font-size: 8px;">Q20</text>
                                <text x="220" y="115" class="axis-label" style="font-size: 8px;">Q30</text>
                                <text x="290" y="115" class="axis-label" style="font-size: 8px;">Q40</text>
                                <text x="340" y="115" class="axis-label" style="font-size: 8px;">Q50</text>

                                <!-- Time line -->
                                <polyline
                                    points="${timeData.map((point, i) => `${50 + i * 30},${100 - (point * 0.75)}`).join(' ')}"
                                    class="data-line"
                                    stroke="#f59e0b"
                                    stroke-width="2"
                                    fill="none"
                                />

                                <!-- Data points -->
                                ${timeData.map((point, i) => `
                                    <circle
                                        cx="${50 + i * 30}"
                                        cy="${100 - (point * 0.75)}"
                                        r="2"
                                        fill="#f59e0b"
                                        stroke="white"
                                        stroke-width="1"
                                    >
                                        <title>Q${(i + 1) * 10}: ${Math.round(point * 1.2)}s avg</title>
                                    </circle>
                                `).join('')}
                            </svg>
                        </div>
                    </div>
                </div>
            `;

            // Hide default graphs and show section graph
            document.getElementById('defaultGraphs').style.display = 'none';
            sectionGraph.style.display = 'block';
        }

        function closeSectionDetails() {
            document.getElementById('sectionGraph').style.display = 'none';
            document.getElementById('defaultGraphs').style.display = 'block';
            document.querySelectorAll('.section-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedSection = null;
        }

        function generateSectionInsights(sectionName, sectionData, accuracy) {
            const insights = [];
            const avgTime = sectionData.total > 0 ? sectionData.time / sectionData.total : 0;
            const avgTimeSeconds = avgTime / 1000;

            // Performance level insights
            if (accuracy >= 85) {
                insights.push("🌟 Excellent performance! You're mastering this section.");
            } else if (accuracy >= 70) {
                insights.push("✅ Good performance. Focus on consistency to reach the next level.");
            } else if (accuracy >= 50) {
                insights.push("📈 Developing skills. Targeted practice will boost your performance.");
            } else {
                insights.push("🎯 Building foundation. Focus on fundamentals for improvement.");
            }

            // Time insights
            const targetTimes = { english: 43, math: 60, reading: 52, science: 52 };
            const targetTime = targetTimes[sectionName] || 50;

            if (avgTimeSeconds > targetTime * 1.2) {
                insights.push(`⏱️ Pacing: ${Math.round(avgTimeSeconds)}s per question. Target ${targetTime}s for optimal timing.`);
            } else if (avgTimeSeconds < targetTime * 0.7 && accuracy < 70) {
                insights.push(`🎯 Consider slowing down slightly. Quick pace but room for accuracy improvement.`);
            } else {
                insights.push(`✨ Good pacing at ${Math.round(avgTimeSeconds)}s per question.`);
            }

            // Section-specific insights
            const sectionSpecific = {
                english: "Focus on grammar rules, punctuation, and rhetorical skills.",
                math: "Practice algebra, geometry, and problem-solving strategies.",
                reading: "Work on comprehension speed and passage analysis techniques.",
                science: "Strengthen data interpretation and scientific reasoning skills."
            };

            if (accuracy < 75) {
                insights.push(`📚 Study tip: ${sectionSpecific[sectionName]}`);
            }

            return insights;
        }

        function generateCompactGridLines() {
            let gridLines = '';
            // Horizontal grid lines
            for (let i = 10; i <= 120; i += 30) {
                gridLines += `<line x1="30" y1="${i}" x2="370" y2="${i}" class="grid-line"/>`;
            }
            // Vertical grid lines
            for (let i = 80; i <= 320; i += 60) {
                gridLines += `<line x1="${i}" y1="10" x2="${i}" y2="120" class="grid-line"/>`;
            }
            return gridLines;
        }

        function generateQuestionGridLines() {
            let gridLines = '';
            // Horizontal grid lines
            for (let i = 10; i <= 100; i += 30) {
                gridLines += `<line x1="30" y1="${i}" x2="370" y2="${i}" class="grid-line"/>`;
            }
            // Vertical grid lines
            for (let i = 80; i <= 320; i += 60) {
                gridLines += `<line x1="${i}" y1="10" x2="${i}" y2="100" class="grid-line"/>`;
            }
            return gridLines;
        }

        function generateQuestionData(sectionName, sectionData) {
            // Use real test results data instead of generated data
            let resultsData = null;

            try {
                if (sectionName === 'english') {
                    const englishAnswers = JSON.parse(localStorage.getItem('englishAnswers') || 'null');
                    resultsData = convertAnswersToResultsFormat(englishAnswers, 'english');
                } else if (sectionName === 'math') {
                    const mathAnswers = JSON.parse(localStorage.getItem('mathAnswers') || 'null');
                    resultsData = convertAnswersToResultsFormat(mathAnswers, 'math');
                } else if (sectionName === 'reading') {
                    const readingAnswers = JSON.parse(localStorage.getItem('readingAnswers') || 'null');
                    resultsData = convertAnswersToResultsFormat(readingAnswers, 'reading');
                } else if (sectionName === 'science') {
                    const scienceAnswers = JSON.parse(localStorage.getItem('scienceAnswers') || 'null');
                    resultsData = convertAnswersToResultsFormat(scienceAnswers, 'science');
                } else if (sectionName === 'composite' || sectionName === 'all') {
                    // For composite/all, use combined data from all sections
                    const english = JSON.parse(localStorage.getItem('englishAnswers') || 'null');
                    const math = JSON.parse(localStorage.getItem('mathAnswers') || 'null');
                    const reading = JSON.parse(localStorage.getItem('readingAnswers') || 'null');
                    const science = JSON.parse(localStorage.getItem('scienceAnswers') || 'null');

                    const allAnswers = [];
                    const allTimes = [];

                    if (english?.answers) {
                        allAnswers.push(...english.answers);
                        allTimes.push(...(english.questionTimes || []));
                    }
                    if (math?.answers) {
                        allAnswers.push(...math.answers);
                        allTimes.push(...(math.questionTimes || []));
                    }
                    if (reading?.answers) {
                        allAnswers.push(...reading.answers);
                        allTimes.push(...(reading.questionTimes || []));
                    }
                    if (science?.answers) {
                        allAnswers.push(...science.answers);
                        allTimes.push(...(science.questionTimes || []));
                    }

                    resultsData = { answers: allAnswers, questionTimes: allTimes };
                }
            } catch (error) {
                console.error('Error loading real test data:', error);
            }

            const accuracyData = [];
            const timeData = [];

            if (resultsData && resultsData.answers) {
                // Use real question data
                const answers = resultsData.answers;
                const times = resultsData.questionTimes || [];

                // Group by 5 questions for better visualization
                const groupSize = Math.max(1, Math.floor(answers.length / 10));

                for (let i = 0; i < Math.min(10, Math.ceil(answers.length / groupSize)); i++) {
                    const startIdx = i * groupSize;
                    const endIdx = Math.min(startIdx + groupSize, answers.length);
                    const group = answers.slice(startIdx, endIdx);
                    const timeGroup = times.slice(startIdx, endIdx);

                    // Calculate accuracy for this group
                    const correct = group.filter(answer => answer.isCorrect).length;
                    const accuracy = group.length > 0 ? (correct / group.length) * 100 : 0;

                    // Calculate average time for this group
                    const avgTime = timeGroup.length > 0 ?
                        timeGroup.reduce((sum, time) => sum + (time || 0), 0) / timeGroup.length / 1000 : 60;

                    accuracyData.push(Math.round(accuracy));
                    timeData.push(Math.round(Math.max(5, Math.min(120, avgTime))));
                }
            } else {
                // Fallback to section averages if no detailed data
                const baseAccuracy = sectionData.total > 0 ? (sectionData.correct / sectionData.total) * 100 : 0;
                const baseTime = sectionData.total > 0 ? sectionData.time / sectionData.total / 1000 : 60;

                for (let i = 0; i < 10; i++) {
                    accuracyData.push(Math.round(baseAccuracy));
                    timeData.push(Math.round(baseTime));
                }
            }

            return { timeData, accuracyData };
        }

        function generateTimeAccuracyData(sectionName, sectionData) {
            // Use real test data - this function is deprecated in favor of generateQuestionData
            // Just return the result from generateQuestionData for consistency
            return generateQuestionData(sectionName, sectionData);
        }

        function initializeDefaultGraphs() {
            console.log('Initializing default graphs...', allSectionResults);
            // Get overall test data
            const overallData = {
                correct: Object.values(allSectionResults).reduce((sum, section) => sum + section.correct, 0),
                total: Object.values(allSectionResults).reduce((sum, section) => sum + section.total, 0),
                time: Object.values(allSectionResults).reduce((sum, section) => sum + section.time, 0)
            };

            console.log('Overall data:', overallData);
            const { timeData, accuracyData } = generateQuestionData('composite', overallData);
            console.log('Generated graph data:', { timeData, accuracyData });

            // Update time graph only (remove accuracy graph)
            const timeGraph = document.getElementById('defaultTimeGraph');
            timeGraph.innerHTML = `
                <!-- Axes -->
                <line x1="30" y1="100" x2="370" y2="100" class="axis-line"/>
                <line x1="30" y1="100" x2="30" y2="10" class="axis-line"/>

                <!-- Y-axis labels -->
                <text x="25" y="15" class="axis-label y-axis-label" style="font-size: 8px;">120s</text>
                <text x="25" y="55" class="axis-label y-axis-label" style="font-size: 8px;">60s</text>
                <text x="25" y="95" class="axis-label y-axis-label" style="font-size: 8px;">0s</text>

                <!-- X-axis labels -->
                <text x="70" y="115" class="axis-label" style="font-size: 7px;">Q10</text>
                <text x="120" y="115" class="axis-label" style="font-size: 7px;">Q20</text>
                <text x="170" y="115" class="axis-label" style="font-size: 7px;">Q30</text>
                <text x="220" y="115" class="axis-label" style="font-size: 7px;">Q40</text>
                <text x="270" y="115" class="axis-label" style="font-size: 7px;">Q50</text>

                <!-- Time line -->
                <polyline
                    points="${timeData.slice(0, 5).map((point, i) => `${50 + i * 65},${100 - (point * 0.75)}`).join(' ')}"
                    class="data-line"
                    stroke="#f59e0b"
                    stroke-width="2"
                    fill="none"
                />

                <!-- Data points -->
                ${timeData.slice(0, 5).map((point, i) => `
                    <circle
                        cx="${50 + i * 65}"
                        cy="${100 - (point * 0.75)}"
                        r="2"
                        fill="#f59e0b"
                        stroke="white"
                        stroke-width="1"
                    >
                        <title>Q${(i + 1) * 10}: ${Math.round(point)}s avg</title>
                    </circle>
                `).join('')}
            `;
        }

        function generateSectionRecommendations(sectionName, sectionData) {
            const recommendations = [];
            const accuracy = sectionData.total > 0 ? (sectionData.correct / sectionData.total) * 100 : 0;

            // Section-specific recommendations
            const sectionAdvice = {
                english: {
                    study: "Focus on grammar rules, sentence structure, and punctuation",
                    practice: "Take more English practice tests to improve timing",
                    weak: "Review comma usage, verb agreement, and transitions"
                },
                math: {
                    study: "Practice algebra, geometry, and trigonometry problems",
                    practice: "Use backsolving and substitution strategies",
                    weak: "Review basic math concepts and formula memorization"
                },
                reading: {
                    study: "Work on reading comprehension and passage analysis",
                    practice: "Practice skimming techniques and time management",
                    weak: "Focus on main idea questions and detail questions"
                },
                science: {
                    study: "Practice data interpretation and scientific reasoning",
                    practice: "Focus on graphs, charts, and experimental design",
                    weak: "Review basic scientific concepts and data analysis"
                }
            };

            const advice = sectionAdvice[sectionName] || sectionAdvice.english;

            if (accuracy >= 80) {
                recommendations.push(`🌟 Excellent ${sectionName} performance! Keep practicing to maintain this level.`);
                recommendations.push(`📈 ${advice.practice}`);
            } else if (accuracy >= 60) {
                recommendations.push(`✅ Good ${sectionName} foundation. ${advice.study}`);
                recommendations.push(`🎯 ${advice.practice}`);
            } else {
                recommendations.push(`📚 ${advice.study}`);
                recommendations.push(`🔍 ${advice.weak}`);
                recommendations.push(`⏰ Spend extra time reviewing ${sectionName} fundamentals`);
            }

            return recommendations;
        }

        // Update calculateResults to include all sections
        function updateAllSectionResults() {
            try {
                const englishAnswers = JSON.parse(localStorage.getItem('englishAnswers') || 'null');
                const mathAnswers = JSON.parse(localStorage.getItem('mathAnswers') || 'null');
                const readingAnswers = JSON.parse(localStorage.getItem('readingAnswers') || 'null');
                const scienceAnswers = JSON.parse(localStorage.getItem('scienceAnswers') || 'null');

                // Convert to expected format
                const diagnosticResults = convertAnswersToResultsFormat(englishAnswers, 'english');
                const mathResults = convertAnswersToResultsFormat(mathAnswers, 'math');
                const readingResults = convertAnswersToResultsFormat(readingAnswers, 'reading');
                const scienceResults = convertAnswersToResultsFormat(scienceAnswers, 'science');

                // Allow loading even with no test data - will show 0 scores

                allSectionResults = {
                    english: calculateSectionData(diagnosticResults, 50),
                    math: calculateSectionData(mathResults, 45),
                    reading: calculateSectionData(readingResults, 40),
                    science: calculateSectionData(scienceResults, 40)
                };
            } catch (error) {
                console.error('Error updating section results:', error);
                // Continue with default 0 values if there's an error
                allSectionResults = {
                    english: { correct: 0, total: 50, time: 0, accuracy: 0 },
                    math: { correct: 0, total: 45, time: 0, accuracy: 0 },
                    reading: { correct: 0, total: 40, time: 0, accuracy: 0 },
                    science: { correct: 0, total: 40, time: 0, accuracy: 0 }
                };
            }
        }

        function calculateSectionData(sectionResults, totalQuestions) {
            if (!sectionResults || !sectionResults.answers) {
                return { correct: 0, total: totalQuestions, time: 0, accuracy: 0 };
            }

            let correct = 0;
            let totalTime = 0;
            let answeredQuestions = 0;
            const { answers, timeSpentPerQuestion } = sectionResults;

            for (let i = 1; i <= totalQuestions; i++) {
                const questionKey = `q${i}`;
                const userAnswer = answers[questionKey];
                const timeSpent = timeSpentPerQuestion?.[questionKey] || 0;

                totalTime += timeSpent;

                if (userAnswer?.answer) {
                    answeredQuestions++;
                    // Check if the answer is actually correct using stored results
                    if (userAnswer.isCorrect === true) {
                        correct++;
                    }
                    // If isCorrect is not available, don't count as correct
                    // This ensures we only show real data, not estimated data
                }
            }

            return {
                correct,
                total: totalQuestions,
                time: totalTime,
                accuracy: answeredQuestions > 0 ? (correct / answeredQuestions) * 100 : 0
            };
        }

        // Charts are handled by individual section selection and graph updates

        // Make topics and questions work with selected section
        let currentAnalysisSection = 'all'; // Default to all sections

        function updateTopicsForSection(sectionName) {
            console.log(`updateTopicsForSection called with: ${sectionName}`);
            currentAnalysisSection = sectionName;
            // Update topics view based on selected section
            if (sectionName === 'all') {
                // Show comprehensive view of all sections
                console.log('Calling updateTopicsAllSections() for composite view');
                updateTopicsAllSections();
            } else if (sectionName === 'english') {
                // Use existing English topics logic with global chapterStats
                const globalChapterStats = window.chapterStats || {};
                console.log('Using English chapterStats:', globalChapterStats);
                console.log('Calling updateTopics() for English view');
                updateTopics(globalChapterStats);
            } else {
                // For other sections, show placeholder topics
                console.log(`Calling updateTopicsPlaceholder() for ${sectionName} view`);
                updateTopicsPlaceholder(sectionName);
            }
            console.log(`updateTopicsForSection completed for: ${sectionName}`);
        }

        function updateTopicsAllSections() {
            console.log('updateTopicsAllSections() starting...');
            const topicGrid = document.getElementById('topicGrid');
            console.log('Got topicGrid element:', topicGrid);

            // Combine English topics with other section summaries
            const allSectionTopics = [
                {
                    name: 'English Grammar & Usage',
                    sections: ['Sentence Structure', 'Punctuation', 'Word Choice', 'Transitions'],
                    accuracy: Object.values(window.chapterStats || {}).length > 0 ?
                        Math.round((Object.values(window.chapterStats || {}).reduce((sum, stat) => sum + stat.correct, 0) /
                                   Object.values(window.chapterStats || {}).reduce((sum, stat) => sum + stat.total, 0)) * 100) : 0,
                    total: Object.values(window.chapterStats || {}).reduce((sum, stat) => sum + stat.total, 0),
                    correct: Object.values(window.chapterStats || {}).reduce((sum, stat) => sum + stat.correct, 0)
                },
                {
                    name: 'Math Problem Solving',
                    sections: ['Algebra', 'Geometry', 'Trigonometry', 'Statistics'],
                    accuracy: allSectionResults.math ? Math.round((allSectionResults.math.correct / allSectionResults.math.total) * 100) : 0,
                    total: allSectionResults.math ? allSectionResults.math.total : 0,
                    correct: allSectionResults.math ? allSectionResults.math.correct : 0
                },
                {
                    name: 'Reading Comprehension',
                    sections: ['Main Ideas', 'Supporting Details', 'Inferences', 'Vocabulary'],
                    accuracy: allSectionResults.reading ? Math.round((allSectionResults.reading.correct / allSectionResults.reading.total) * 100) : 0,
                    total: allSectionResults.reading ? allSectionResults.reading.total : 0,
                    correct: allSectionResults.reading ? allSectionResults.reading.correct : 0
                },
                {
                    name: 'Scientific Reasoning',
                    sections: ['Data Interpretation', 'Research Summaries', 'Conflicting Viewpoints'],
                    accuracy: allSectionResults.science ? Math.round((allSectionResults.science.correct / allSectionResults.science.total) * 100) : 0,
                    total: allSectionResults.science ? allSectionResults.science.total : 0,
                    correct: allSectionResults.science ? allSectionResults.science.correct : 0
                }
            ];

            topicGrid.innerHTML = allSectionTopics.map((topic, index) => {
                const scoreLevel = topic.accuracy >= 75 ? 'high' : topic.accuracy >= 50 ? 'medium' : 'low';
                return `
                    <div class="topic-card">
                        <div class="topic-header">
                            <div class="topic-name">${topic.name}</div>
                            <div class="topic-summary">
                                <span class="topic-score ${scoreLevel}">${topic.accuracy}% (${topic.correct}/${topic.total})</span>
                            </div>
                        </div>
                        <div style="padding: 0.75rem 1rem;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${topic.sections.map(section => `
                                    <span style="background: #f1f5f9; color: #64748b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${section}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            console.log('updateTopicsAllSections() completed - composite topics set in DOM');
        }

        function updateTopicsPlaceholder(sectionName) {
            const topicGrid = document.getElementById('topicGrid');
            const sectionData = allSectionResults[sectionName];

            const sectionTopics = {
                math: [
                    {name: 'Pre-Algebra & Elementary Algebra', questions: 14, description: 'Basic operations, linear equations, inequalities'},
                    {name: 'Intermediate Algebra', questions: 10, description: 'Quadratic equations, polynomials, radicals'},
                    {name: 'Coordinate Geometry', questions: 9, description: 'Graphs, slopes, distance, midpoint'},
                    {name: 'Plane Geometry', questions: 14, description: 'Angles, triangles, circles, area, volume'},
                    {name: 'Trigonometry', questions: 4, description: 'Basic trig functions, identities'}
                ],
                reading: [
                    {name: 'Literary Narrative', questions: 10, description: 'Fiction passages, character analysis'},
                    {name: 'Social Science', questions: 10, description: 'Psychology, sociology, economics'},
                    {name: 'Humanities', questions: 10, description: 'Art, music, philosophy, literature'},
                    {name: 'Natural Science', questions: 10, description: 'Biology, chemistry, physics, earth science'}
                ],
                science: [
                    {name: 'Data Representation', questions: 15, description: 'Charts, graphs, tables'},
                    {name: 'Research Summaries', questions: 18, description: 'Experimental procedures and results'},
                    {name: 'Conflicting Viewpoints', questions: 7, description: 'Multiple scientific perspectives'}
                ]
            };

            const topics = sectionTopics[sectionName] || [];
            const totalQuestions = (sectionData && sectionData.total) ? sectionData.total : 0;
            const totalCorrect = (sectionData && sectionData.correct) ? sectionData.correct : 0;

            topicGrid.innerHTML = topics.map((topic, index) => {
                // Estimate topic performance based on overall section performance
                const sectionAccuracy = totalQuestions > 0 ? (totalCorrect / totalQuestions) : 0;
                const estimatedCorrect = Math.round(topic.questions * sectionAccuracy);
                const accuracy = topic.questions > 0 ? Math.round((estimatedCorrect / topic.questions) * 100) : 0;
                const scoreLevel = accuracy >= 75 ? 'high' : accuracy >= 50 ? 'medium' : 'low';

                return `
                    <div class="topic-card" data-chapter="${sectionName}-topic-${index}">
                        <div class="topic-header" onclick="toggleTopic('${sectionName}-topic-${index}')">
                            <div class="topic-name">${topic.name}</div>
                            <div class="topic-summary">
                                <span class="topic-score ${scoreLevel}">${accuracy}% (${estimatedCorrect}/${topic.questions})</span>
                                <span class="expand-icon">▼</span>
                            </div>
                        </div>
                        <div class="topic-details">
                            <div style="padding: 0.5rem; background: #f8fafc; border-radius: 4px; margin-bottom: 0.5rem;">
                                <div style="font-size: 0.8rem; color: #4a5568;">
                                    <strong>Focus:</strong> ${topic.description}
                                </div>
                            </div>
                            <div class="topic-stats">
                                <div class="topic-stat-item">
                                    <div class="topic-stat-value">${accuracy}%</div>
                                    <div class="topic-stat-label">Est. Accuracy</div>
                                </div>
                                <div class="topic-stat-item">
                                    <div class="topic-stat-value">${estimatedCorrect}/${topic.questions}</div>
                                    <div class="topic-stat-label">Est. Correct</div>
                                </div>
                                <div class="topic-stat-item">
                                    <div class="topic-stat-value">${topic.questions}</div>
                                    <div class="topic-stat-label">Total Questions</div>
                                </div>
                            </div>
                            ${accuracy < 70 ? `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 3px;">
                                    <div style="font-size: 0.75rem; color: #7f1d1d;">
                                        <strong>Study:</strong> Focus on ${topic.description.toLowerCase()}
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0fdf4; border-left: 3px solid #10b981; border-radius: 3px;">
                                    <div style="font-size: 0.75rem; color: #14532d;">
                                        <strong>Strong:</strong> Keep practicing ${topic.description.toLowerCase()}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateQuestionsForSection(sectionName) {
            const questionsGrid = document.getElementById('allQuestionsGrid');

            if (sectionName === 'all') {
                // Show overview of all sections
                updateAllQuestionsOverview();
            } else if (sectionName === 'english') {
                // Use existing English questions logic
                updateAllQuestions();
            } else {
                // For other sections, show estimated question grid
                const sectionQuestionCounts = { math: 45, reading: 40, science: 40 };
                const questionCount = sectionQuestionCounts[sectionName] || 0;
                const sectionData = allSectionResults[sectionName];

                // Try to get real test data for this section
                let realTestData = null;
                try {
                    if (sectionName === 'math') {
                        const mathAnswers = JSON.parse(localStorage.getItem('mathAnswers') || 'null');
                        realTestData = convertAnswersToResultsFormat(mathAnswers, 'math');
                    } else if (sectionName === 'reading') {
                        const readingAnswers = JSON.parse(localStorage.getItem('readingAnswers') || 'null');
                        realTestData = convertAnswersToResultsFormat(readingAnswers, 'reading');
                    } else if (sectionName === 'science') {
                        const scienceAnswers = JSON.parse(localStorage.getItem('scienceAnswers') || 'null');
                        realTestData = convertAnswersToResultsFormat(scienceAnswers, 'science');
                    }
                } catch (error) {
                    console.error('Error loading test data for', sectionName, error);
                }

                if (realTestData && realTestData.answers) {
                    // Show real question data
                    let questionsHTML = '<div style="margin-bottom: 1rem; text-align: center;"><h3>Question Overview</h3><p style="color: #6b7280; margin-bottom: 1.5rem;">Your actual performance on each question</p></div>';

                    questionsHTML += '<div class="question-grid" style="margin-bottom: 2rem;">';

                    for (let i = 1; i <= questionCount; i++) {
                        const questionKey = `q${i}`;
                        const userAnswer = realTestData.answers[questionKey];
                        const isCorrect = userAnswer?.isCorrect === true;
                        const bubbleClass = userAnswer ? (isCorrect ? 'correct' : 'incorrect') : 'unanswered';

                        questionsHTML += `
                            <div class="question-bubble ${bubbleClass}"
                                 onclick="showSectionQuestionDetail('${sectionName}', ${i}, ${isCorrect})"
                                 title="Question ${i} - ${userAnswer ? (isCorrect ? 'Correct' : 'Incorrect') : 'Not Answered'}">
                                ${i}
                            </div>
                        `;
                    }

                    questionsHTML += '</div>';

                    // Add real summary stats
                    const correctCount = Object.values(realTestData.answers).filter(answer => answer?.isCorrect === true).length;
                    const incorrectCount = Object.values(realTestData.answers).filter(answer => answer?.isCorrect === false).length;
                    const realAccuracy = (correctCount + incorrectCount) > 0 ? (correctCount / (correctCount + incorrectCount)) * 100 : 0;

                    questionsHTML += `
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${correctCount}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Correct</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${incorrectCount}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Incorrect</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #4299e1;">${Math.round(realAccuracy)}%</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Accuracy</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;">${questionCount}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Total Questions</div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('allQuestionsGrid').innerHTML = questionsHTML;
                } else {
                    // No test data available for this section
                    const questionsHTML = `
                        <div style="text-align: center; color: #6b7280; padding: 3rem; background: #f8fafc; border-radius: 8px;">
                            <div style="font-size: 1.5rem; margin-bottom: 1rem;">📝</div>
                            <h3 style="margin-bottom: 1rem; color: #374151;">No Test Data Available</h3>
                            <p style="margin-bottom: 1.5rem;">You haven't completed the ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} test yet.</p>
                            <button onclick="window.location.href='${sectionName}-test.html'" style="background: #4299e1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Take ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} Test
                            </button>
                        </div>
                    `;
                    document.getElementById('allQuestionsGrid').innerHTML = questionsHTML;
                }
            }
        }

        // Add function to show section question details
        function showSectionQuestionDetail(sectionName, questionNum, isCorrect) {
            const modal = document.getElementById('questionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} Question ${questionNum}`;

            const statusClass = isCorrect ? 'correct' : 'incorrect';
            const statusText = isCorrect ? 'Estimated Correct' : 'Estimated Incorrect';

            const sectionInfo = {
                math: {
                    avgTime: '60s',
                    tips: 'Use backsolving, substitute answer choices, look for patterns'
                },
                reading: {
                    avgTime: '52s',
                    tips: 'Skim passage first, refer back to text, eliminate wrong answers'
                },
                science: {
                    avgTime: '52s',
                    tips: 'Focus on graphs and data, don\'t get caught up in complex scientific terms'
                }
            };

            const info = sectionInfo[sectionName] || { avgTime: '60s', tips: 'Practice section-specific strategies' };

            modalBody.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div class="question-bubble ${statusClass}" style="display: inline-flex; width: 60px; height: 60px; font-size: 1.2rem;">
                        ${questionNum}
                    </div>
                    <h4 style="margin-top: 0.5rem; color: ${isCorrect ? '#166534' : '#dc2626'};">${statusText}</h4>
                </div>

                <div style="background-color: #f8f9fa; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                    <div style="margin-bottom: 0.5rem;"><strong>Section:</strong> ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Question Number:</strong> ${questionNum}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Target Time:</strong> ${info.avgTime}</div>
                    <div><strong>Section Strategy:</strong> ${info.tips}</div>
                </div>

                <div style="padding: 1rem; background-color: #e0f2fe; border-left: 4px solid #0288d1; border-radius: 0.5rem;">
                    <h5 style="color: #01579b; margin-bottom: 0.5rem;">Note about Estimates</h5>
                    <p style="margin: 0; color: #0277bd; font-size: 0.9rem;">
                        This analysis is based on your overall ${sectionName} section performance.
                        For detailed question-by-question analysis, complete more ${sectionName} practice tests.
                    </p>
                </div>

                ${!isCorrect ? `
                    <div style="margin-top: 1rem; padding: 1rem; background-color: #fef2f2; border-left: 4px solid #ef4444; border-radius: 0.5rem;">
                        <h5 style="color: #dc2626; margin-bottom: 0.5rem;">Study Recommendation</h5>
                        <p style="margin: 0; color: #7f1d1d;">Continue practicing ${sectionName} questions. ${info.tips}</p>
                    </div>
                ` : `
                    <div style="margin-top: 1rem; padding: 1rem; background-color: #f0fdf4; border-left: 4px solid #10b981; border-radius: 0.5rem;">
                        <h5 style="color: #166534; margin-bottom: 0.5rem;">Keep It Up!</h5>
                        <p style="margin: 0; color: #14532d;">You're on track with this ${sectionName} question type.</p>
                    </div>
                `}
            `;

            modal.classList.add('active');
        }

        // Add function to show overview of all questions
        function updateAllQuestionsOverview() {
            const questionsGrid = document.getElementById('allQuestionsGrid');

            const sectionOverview = [
                {
                    name: 'English',
                    total: 50,
                    correct: Object.values(window.chapterStats || {}).reduce((sum, stat) => sum + stat.correct, 0),
                    color: '#3b82f6'
                },
                {
                    name: 'Math',
                    total: allSectionResults.math ? allSectionResults.math.total : 45,
                    correct: allSectionResults.math ? allSectionResults.math.correct : 0,
                    color: '#10b981'
                },
                {
                    name: 'Reading',
                    total: allSectionResults.reading ? allSectionResults.reading.total : 40,
                    correct: allSectionResults.reading ? allSectionResults.reading.correct : 0,
                    color: '#f59e0b'
                },
                {
                    name: 'Science',
                    total: allSectionResults.science ? allSectionResults.science.total : 40,
                    correct: allSectionResults.science ? allSectionResults.science.correct : 0,
                    color: '#8b5cf6'
                }
            ];

            const totalQuestions = sectionOverview.reduce((sum, section) => sum + section.total, 0);
            const totalCorrect = sectionOverview.reduce((sum, section) => sum + section.correct, 0);

            questionsGrid.innerHTML = `
                <div style="margin-bottom: 2rem; text-align: center;">
                    <h3 style="margin-bottom: 1rem;">All Sections Overview</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #1a1a1a;">${totalCorrect}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Total Correct</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #1a1a1a;">${totalQuestions}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Total Questions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #10b981;">${Math.round((totalCorrect / totalQuestions) * 100)}%</div>
                            <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase;">Overall Accuracy</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                    ${sectionOverview.map(section => {
                        const accuracy = section.total > 0 ? Math.round((section.correct / section.total) * 100) : 0;
                        return `
                            <div style="background: white; border: 1px solid #f1f5f9; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="margin: 0; color: ${section.color};">${section.name}</h4>
                                    <span style="background: ${section.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600;">${accuracy}%</span>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="background: #f1f5f9; border-radius: 6px; height: 8px; overflow: hidden;">
                                        <div style="background: ${section.color}; height: 100%; width: ${accuracy}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #6b7280;">
                                    <span>${section.correct} correct</span>
                                    <span>${section.total} total</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Initialize results after loading - optimized for faster loading
        // Force immediate loading - bypass all delays
        // Force composite view to be displayed
        function forceCompositeView() {
            console.log('forceCompositeView() called');

            // 1. Ensure composite score is selected visually
            document.querySelectorAll('.section-card').forEach(card => {
                card.classList.remove('selected');
            });
            const compositeScore = document.querySelector('.composite-score');
            if (compositeScore) {
                compositeScore.classList.add('selected');
                console.log('Composite score button selected');
            }

            // 2. Set selectedSection global variable
            selectedSection = 'all';
            currentAnalysisSection = 'all';
            console.log('Global variables set to "all"');

            // 3. Force composite topics
            updateTopicsAllSections();

            // 4. Force composite questions
            updateAllQuestionsOverview();

            // 5. Update section details
            showSectionDetails('all');

            console.log('forceCompositeView() completed');
        }

        function forceLoad() {
            console.log('Starting analytics load...');

            // Hide loading immediately
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
                console.log('Loading hidden');
            }

            try {
                // Check for actual test data (don't create fake data)
                console.log('Checking for actual test data...');
                const scienceAnswers = localStorage.getItem('scienceAnswers');
                if (scienceAnswers) {
                    console.log('Found science test data:', scienceAnswers);
                } else {
                    console.log('No test data found yet - will show empty state');
                }

                // Load real test data and call existing functions in correct order
                updateAllSectionResults();
                calculateResults();

                // Wait for data to be processed, then force composite view multiple times
                setTimeout(() => {
                    initializeDefaultGraphs();

                    // Force composite view immediately
                    console.log('Initial composite view force...');
                    forceCompositeView();

                    // Backup attempts at different intervals
                    setTimeout(() => {
                        console.log('First backup composite view force...');
                        forceCompositeView();
                    }, 100);

                    setTimeout(() => {
                        console.log('Second backup composite view force...');
                        forceCompositeView();
                    }, 300);

                    setTimeout(() => {
                        console.log('Final backup composite view force...');
                        forceCompositeView();
                    }, 500);

                }, 200);

                console.log('Analytics loaded successfully with real data');
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Still show the page with default 0 values, don't block loading
                console.log('Analytics loaded with default values (no test data)');
            }
        }

        // Try multiple approaches to ensure loading
        forceLoad();
        setTimeout(forceLoad, 50);
        document.addEventListener('DOMContentLoaded', forceLoad);

        // Also try forcing composite view at page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                console.log('DOMContentLoaded - forcing composite view...');
                forceCompositeView();
            }, 100);
            setTimeout(() => {
                console.log('DOMContentLoaded backup - forcing composite view...');
                forceCompositeView();
            }, 500);
            setTimeout(() => {
                console.log('DOMContentLoaded final backup - forcing composite view...');
                forceCompositeView();
            }, 1000);
        });

        // Final backup to ensure composite score is selected
        setTimeout(() => {
            console.log('Ultimate fallback - forcing composite view...');
            forceCompositeView();
        }, 1500);
    </script>
</body>
</html>