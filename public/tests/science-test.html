<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Diagnostic Test</title>
    <link rel="stylesheet" href="shared-test-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="test-container ">
        <!-- Header -->
        <div class="test-header">
                        <div class="header-content">
                <a href="/" class="logo">Nomi Academy</a>
                <div class="header-center"></div>
                <div class="header-right">
                    <span class="question-counter">
                        <span class="question-counter-label">Answered</span>
                        <span class="question-counter-value" id="questionCounter">0 of 75</span>
                    </span>
                    <div class="timer-container">
                        <span class="timer-label">Total Time Left</span>
                        <div class="timer" id="timer">35:00</div>
                    </div>
                    <button class="end-section-link" onclick="endSection()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                        End Section
                    </button>
                </div>
            </div>
        </div>

        <div class="test-main">
            <!-- Main Content -->
            <div class="test-content">
                <!-- Flag Bar -->
                <div class="flag-bar">
                    <span class="item-number" id="itemNumber">Item 1</span>
                                        <button class="flag-button" id="flagBtn" onclick="toggleFlag()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"></path>
                        </svg>
                        Flag
                    </button>
                </div>

                <!-- Passages Section -->
                <div class="passage-section" id="passageSection">
                    <div id="loadingPassage" style="padding: 2rem; text-align: center;">Loading passages...</div>
                </div>

                <!-- Questions Section -->
                <div class="question-section" id="questionSection">
                    <div id="loadingQuestions" style="padding: 2rem; text-align: center;">Loading questions...</div>
                </div>

                                <!-- Question Sidebar -->
                <div class="question-sidebar">
                    <div class="sidebar-icon" onclick="toggleSidebar()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </div>
                    <div class="sidebar-text">Index</div>
                    <div class="sidebar-divider"></div>
                    <div class="sidebar-questions" id="sidebarQuestions"></div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                                <button class="nav-button" id="prevBtn" onclick="previousQuestion()">PREV</button>
                <button class="nav-button primary" id="nextBtn" onclick="nextQuestion()">NEXT</button>
            </div>
        </div>
    </div>

    <!-- Question Navigation Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Question Navigator</h2>
                <button class="modal-close" onclick="closeQuestionModal()">âœ•</button>
            </div>
            <div class="question-grid" id="questionGrid"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://rabavobdklnwvwsldbix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYmF2b2Jka2xud3Z3c2xkYml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjU0NzgsImV4cCI6MjA3NTM0MTQ3OH0.z_1N3TG-cS9Bc1s7UAif91PkIjhBKvicrUqupiNP80Y';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentQuestion = 1;
        let totalQuestions = 40;
        let answers = {};
        let flaggedQuestions = new Set();
        let timeLeft = 35 * 60;
        let questionsData = [];
        let passagesData = {};
        let questionToPassage = {};

        async function loadQuestionsFromSupabase() {
            try {
                console.log('Loading Science questions from Supabase...');

                const { data, error } = await supabase
                    .from('diagnostic_test_questions')
                    .select('*')
                    .eq('section', 'science')
                    .order('question_id');

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('Loaded data:', data);

                if (!data || data.length === 0) {
                    throw new Error('No questions found in database');
                }

                questionsData = data;
                totalQuestions = data.length;

                // Group passages and build question to passage mapping
                const passageMap = {};
                data.forEach((q, index) => {
                    if (q.passage && q.passage.trim()) {
                        if (!passageMap[q.passage]) {
                            passageMap[q.passage] = Object.keys(passageMap).length + 1;
                        }
                        questionToPassage[q.question_id] = passageMap[q.passage];

                        if (!passagesData[passageMap[q.passage]]) {
                            passagesData[passageMap[q.passage]] = {
                                text: q.passage,
                                title: q.lesson_title || 'Passage'
                            };
                        }
                    }
                });

                console.log('Rendering passages and questions...');
                renderPassages();
                renderQuestions();
                updateDisplay();
                generateSidebarQuestions();
                startTimer();
                console.log('Successfully loaded all content');
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('loadingQuestions').innerHTML =
                    `<div style="color: red; padding: 2rem; text-align: center;">
                        <p style="font-size: 1.2rem; margin-bottom: 1rem;">Error Loading Questions</p>
                        <p>${error.message || 'Please check console for details'}</p>
                        <p style="margin-top: 1rem;">Try refreshing the page or contact support.</p>
                    </div>`;
                document.getElementById('loadingPassage').innerHTML = '';
            }
        }

        function renderPassages() {
            const passageSection = document.getElementById('passageSection');
            passageSection.innerHTML = '';

            Object.keys(passagesData).forEach(passageNum => {
                const passage = passagesData[passageNum];
                const passageDiv = document.createElement('div');
                passageDiv.className = 'passage-content';
                passageDiv.id = `passage${passageNum}`;

                // Format passage text with proper paragraphs
                const formattedText = passage.text
                    .split('\n\n')
                    .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
                    .join('');

                passageDiv.innerHTML = `
                    <div class="passage-text">
                        <div class="passage-title">${passage.title}</div>
                        ${formattedText}
                    </div>
                `;

                passageSection.appendChild(passageDiv);
            });
        }

        function renderQuestions() {
            const questionSection = document.getElementById('questionSection');
            questionSection.innerHTML = '';

            questionsData.forEach(q => {
                try {
                    // Handle both JSON string and object for choices
                    let choices;
                    if (typeof q.choices === 'string') {
                        choices = JSON.parse(q.choices);
                    } else if (Array.isArray(q.choices)) {
                        choices = q.choices;
                    } else {
                        console.error('Invalid choices format for question', q.question_id, q.choices);
                        choices = ['Error loading choices'];
                    }

                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    questionDiv.id = `question${q.question_id}`;

                    const choicesHTML = choices.map((choice, index) => {
                        const isOdd = q.question_id % 2 === 1;
                        const letters = isOdd ? ['A', 'B', 'C', 'D'] : ['F', 'G', 'H', 'J'];
                        const letter = letters[index];

                        return `
                            <label class="answer-choice">
                                <input type="radio" name="q${q.question_id}" value="${letter}">
                                <span class="answer-text">${choice}</span>
                            </label>
                        `;
                    }).join('');

                    questionDiv.innerHTML = `
                        <div class="question-number">${q.question_id}.</div>
                        <div class="question-text">${q.question || 'Select the correct answer:'}</div>
                        <div class="answer-choices">
                            ${choicesHTML}
                        </div>
                    `;

                    questionSection.appendChild(questionDiv);
                } catch (error) {
                    console.error('Error rendering question', q.question_id, error);
                }
            });
        }

        function updateDisplay() {
            document.querySelectorAll('.question').forEach(q => q.classList.remove('active'));
            document.querySelectorAll('.passage-content').forEach(p => p.classList.remove('active'));

            const questionElement = document.getElementById(`question${currentQuestion}`);
            if (questionElement) {
                questionElement.classList.add('active');
            }

            const passageNum = questionToPassage[currentQuestion];
            if (passageNum) {
                const passageElement = document.getElementById(`passage${passageNum}`);
                if (passageElement) {
                    passageElement.classList.add('active');
                }
            }

            document.getElementById('prevBtn').disabled = currentQuestion === 1;

            if (currentQuestion === totalQuestions) {
                document.getElementById('nextBtn').textContent = 'End Science â†’ Results';
                document.getElementById('nextBtn').onclick = () => window.location.href = 'test-results.html';
            } else {
                document.getElementById('nextBtn').textContent = 'Next â†’';
                document.getElementById('nextBtn').onclick = nextQuestion;
            }

            document.getElementById('questionCounter').textContent = `${currentQuestion} of ${totalQuestions}`;
            document.getElementById('itemNumber').textContent = `Item ${currentQuestion}`;

            updateFlagButton();
        }

        function nextQuestion() {
            if (currentQuestion < totalQuestions) {
                currentQuestion++;
                updateDisplay();
            }
        }

        function previousQuestion() {
            if (currentQuestion > 1) {
                currentQuestion--;
                updateDisplay();
            }
        }

        function goToQuestion(questionNum) {
            if (questionNum >= 1 && questionNum <= totalQuestions) {
                currentQuestion = questionNum;
                updateDisplay();
                closeQuestionModal();
            }
        }

        function toggleFlag() {
            if (flaggedQuestions.has(currentQuestion)) {
                flaggedQuestions.delete(currentQuestion);
            } else {
                flaggedQuestions.add(currentQuestion);
            }
            updateFlagButton();
            updateQuestionGrid();
        }

        function updateFlagButton() {
            const flagBtn = document.getElementById('flagBtn');
            if (flaggedQuestions.has(currentQuestion)) {
                flagBtn.textContent = 'ðŸ³ï¸ Unflag';
                flagBtn.classList.add('flagged');
            } else {
                flagBtn.textContent = 'ðŸ³ï¸ Flag';
                flagBtn.classList.remove('flagged');
            }
        }

        function showQuestionModal() {
            document.getElementById('questionModal').style.display = 'block';
            generateQuestionGrid();
        }

        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
        }

        function generateQuestionGrid() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= totalQuestions; i++) {
                const item = document.createElement('div');
                item.className = 'question-nav-item';
                item.textContent = i;
                item.onclick = () => goToQuestion(i);

                if (i === currentQuestion) {
                    item.classList.add('current');
                } else if (answers[`q${i}`]) {
                    item.classList.add('answered');
                } else if (flaggedQuestions.has(i)) {
                    item.classList.add('flagged');
                }

                grid.appendChild(item);
            }
        }
        function generateSidebarQuestions() {
            const sidebar = document.getElementById('sidebarQuestions');
            sidebar.innerHTML = '';

            for (let i = 1; i <= totalQuestions; i++) {
                const item = document.createElement('div');
                item.className = 'sidebar-question-item';
                item.textContent = i;
                item.onclick = () => goToQuestion(i);

                if (i === currentQuestion) {
                    item.classList.add('current');
                } else if (answers[`q${i}`]) {
                    item.classList.add('answered');
                } else if (flaggedQuestions.has(i)) {
                    item.classList.add('flagged');
                }

                sidebar.appendChild(item);
            }
        }

        function toggleSidebar() {
            // Sidebar is always visible now, this could be used for future expand/collapse
            showQuestionModal();
        }

        function updateQuestionGrid() {
            generateSidebarQuestions();
            if (document.getElementById('questionModal').style.display === 'block') {
                generateQuestionGrid();
            }
        }

        function startTimer() {
            const timer = document.getElementById('timer');

            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;

                timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    alert('Time is up! The test will now end.');
                    window.location.href = 'test-results.html';
                    return;
                }

                timeLeft--;
            };

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                const questionDiv = e.target.closest('.question');
                const questionName = e.target.name;

                answers[questionName] = e.target.value;

                questionDiv.querySelectorAll('.answer-choice').forEach(choice => {
                    choice.classList.remove('selected');
                });
                e.target.closest('.answer-choice').classList.add('selected');

                updateQuestionGrid();
            }
        });

        window.onclick = function(event) {
            const modal = document.getElementById('questionModal');
            if (event.target === modal) {
                closeQuestionModal();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' && currentQuestion > 1) {
                previousQuestion();
            } else if (e.key === 'ArrowRight' && currentQuestion < totalQuestions) {
                nextQuestion();
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFlag();
            } else if (e.key === 'q' || e.key === 'Q') {
                showQuestionModal();
            } else if (e.key === 'Escape') {
                closeQuestionModal();
            }
        });

        function endSection() {
            if (confirm('Are you sure you want to end this section? You will not be able to return to it.')) {
                const finalAnswers = {};
                for (let i = 1; i <= totalQuestions; i++) {
                    const selected = document.querySelector(`input[name="q${i}"]:checked`);
                    if (selected) {
                        finalAnswers[`q${i}`] = selected.value;
                    }
                }

                console.log('Science Test Answers:', finalAnswers);
                localStorage.setItem('scienceAnswers', JSON.stringify(finalAnswers));

                window.location.href = 'test-results.html';
            }
        }

        loadQuestionsFromSupabase();
    </script>
</body>
</html>