#!/usr/bin/env node
import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
dotenv.config({ path: join(__dirname, '../../.env') });

const supabase = createClient(process.env.REACT_APP_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
const TEST_NUMBER = 4;
const answerKeys = JSON.parse(fs.readFileSync(join(__dirname, '../../data/test4-answer-keys.json'), 'utf8'));

const PASSAGE_TEXT = `Of the many great civilizations that flourished and withered in ancient Anatolia, the Lydian does not rank among the best known. The Lydians formed a small kingdom in the seventh century BC, but at its height, the Lydian kingdom was little more than an overgrown city-state spread out from Sardis. The Lydian kings were not celebrated in myth or song as great warriors, conquerors, builders, or even lovers. Only one name of ancient Lydia is commonly known todayâ€”Croesus. He ascended to the Lydian throne in 560 BC to rule a kingdom that was already rich. His ancestors had made a firm economic basis for the kingdom's wealth by manufacturing some of the best perfumes and cosmetics of the ancient world; yet these goods alone could not have raised Croesus to the level of wealth that myth accords him. For that, he depended on another invention of his ancestorsâ€”coins, a new and revolutionary form of money.

Something similar to money and something resembling markets can be found in Mesopotamia, China, Egypt, and many other parts of the world, but they did not actually use coins until the rise of Lydia and the subsequent minting of the first coins, between 640 and 630 BC. The genius of the Lydian kings can be seen in their recognition of the need for very small and easily transported ingots worth no more than a few days' labor or a small part of a farmer's harvest. By making these small ingots in a standardized size and weight, and by stamping on them an emblem that verified their worth to even the illiterate, the kings of Lydia exponentially expanded the possibilities of commercial enterprise.

The Lydians made the first coins of electrum, a naturally occurring mixture of gold and silver. They made the electrum into oval slugs several times thicker than modern coins, or about the size of the end digit of an adult's thumb. To ensure their authenticity, the king had each one stamped with the emblem of a lion's head. The stamping also flattened the lumps, beginning their transition from an oval nugget to a flat, circular coin. By making the nuggets the same weight and thus approximately the same size, the king eliminated one of the most time-consuming steps in commerce: the need to weigh the gold each time a transaction was made. Now merchants could assess the value by tale, or by simply counting the number of coins. Such standardization greatly reduced the opportunity for cheating on the amount or quality of gold and silver in an exchange. One did not need to be an expert in handling a scale or in judging the purity of metal in order to buy a basket of wheat, a pair of sandals, or an amphora of olive oil. The use of coins that had been weighed and stamped in the royal workshop made it possible for commerce to proceed much more rapidly and honestly, and it allowed people to participate even if they did not own a scale. The commerce of coins opened up new dimensions for new segments of the population.

The wealth of Croesus and his ancestors arose not from conquest but from trade. During his reign (560-546 BC), Croesus created new coins of pure gold and silver rather than electrum. Using their newly invented coins as a standardized medium of exchange, the Lydian merchants traded in the daily necessities of lifeâ€”grain, oil, leather, pottery, and woodâ€”as well as in luxury goods such as perfumes, cosmetics, jewelry, musical instruments, glazed ceramics, bronze figurines, mohair, purple cloth, marble, and ivory.

The variety and abundance of commercial goods quickly led to another innovation: the retail market. Rather than leaving buyers to seek out the home of someone who might have oil or jewelry to sell, the kings of Sardis set up an innovative new system in which anyone, even a stranger, with something to sell could come to a central market. Numerous small shops lined the market, and each merchant specialized in particular goods. One sold meat, and another offered grain. One sold jewelry, another cloth. One sold musical instruments, another pots. This market system began in the late seventh century BC, but its descendants can clearly be seen in the later Greek agora, in the medieval market squares of northern Europe, and in suburban shopping malls of the contemporary United States. With the conquest of Lydia by Cyrus, the reign of Croesus ended, and the Lydian kingdom disappeared from the pages of history. The impact of that small and relatively unknown kingdom has remained vastly disproportionate to its geographic size and relatively minor role in ancient history.`;

const questions = [
  {question_number: 11, question_stem: "The main idea of the passage is that:", choice_a: "the system of coins and trade created by Lydians radically transformed commerce.", choice_b: "the development of currency can be traced chronologically from 640 BC to 560 BC.", choice_c: "money was invented when Croesus became king of Lydia.", choice_d: "the coins minted in Lydia are the first gold coins known to exist.", correct_answer: answerKeys.reading[11], question_type: "main_idea", question_category: "KID"},
  {question_number: 12, question_stem: "According to the passage, one outcome of stamping Lydian coins with the emblem of a lion's head was that the coins:", choice_a: "became easier to distinguish from currency used in the common marketplace.", choice_b: "were no longer clearly marked as property of the king.", choice_c: "varied more in size and weight.", choice_d: "became flatter and more circular.", correct_answer: answerKeys.reading[12], question_type: "detail", question_category: "KID"},
  {question_number: 13, question_stem: "What is the \"innovative new system\" referred to in line 71?", choice_a: "The sale of goods by a producer to a merchant and then to a consumer", choice_b: "The sale of goods over long distances", choice_c: "The use of scales in the marketplace for business transactions", choice_d: "The sale of many types of goods in one marketplace", correct_answer: answerKeys.reading[13], question_type: "detail", question_category: "KID"},
  {question_number: 14, question_stem: "The author most likely uses the term overgrown city-state (lines 5-6) in order to:", choice_a: "emphasize the importance of Lydia.", choice_b: "indicate the rapid growth of Sardis.", choice_c: "make the point that Lydia was small.", choice_d: "identify the government structure of Lydia.", correct_answer: answerKeys.reading[14], question_type: "purpose", question_category: "CS"},
  {question_number: 15, question_stem: "The passage states that when Croesus ascended the throne, Lydia was already:", choice_a: "celebrated in myths.", choice_b: "past the peak of its political power.", choice_c: "at war with Sardis.", choice_d: "in a firm economic position.", correct_answer: answerKeys.reading[15], question_type: "detail", question_category: "KID"},
  {question_number: 16, question_stem: "As it is used in line 15, the word accords most nearly means:", choice_a: "confines.", choice_b: "assigns.", choice_c: "owes.", choice_d: "measures.", correct_answer: answerKeys.reading[16], question_type: "vocab", question_category: "CS"},
  {question_number: 17, question_stem: "According to the passage, which of the following is true of electrum?", choice_a: "It is naturally occurring.", choice_b: "It was worth more than gold under Croesus's rule.", choice_c: "It is easier to stamp than silver or gold.", choice_d: "It is heavier than silver.", correct_answer: answerKeys.reading[17], question_type: "detail", question_category: "KID"},
  {question_number: 18, question_stem: "Which of the following cause-effect relationships is referred to in the passage?", choice_a: "Instituting scales in the marketplace led to greater honesty in transactions.", choice_b: "Introducing standardized coins into commerce made it more inclusive of a wide range of people.", choice_c: "Stamping designs on coins initially led some buyers to confuse coins with jewelry.", choice_d: "Lydia's conquering of neighboring countries allowed Lydia to replace their monetary systems.", correct_answer: answerKeys.reading[18], question_type: "inference", question_category: "KID"},
  {question_number: 19, question_stem: "In the passage, wood is mentioned as an example of a:", choice_a: "material that coins were made of prior to the reign of Croesus.", choice_b: "material from which Croesus first made coins.", choice_c: "daily necessity of life during the reign of Croesus.", choice_d: "precious material Lydia imported for use by the wealthy class.", correct_answer: answerKeys.reading[19], question_type: "detail", question_category: "KID"},
  {question_number: 20, question_stem: "Which of the following statements best paraphrases the last sentence of the passage?", choice_a: "Lydia played a minor role in ancient history, in spite of its rulers' attempts to achieve glory.", choice_b: "The world before Lydia and the one after Lydia are vastly different, due to the greed of Croesus.", choice_c: "Despite its size and historical status, Lydia has had an enormous influence on the world.", choice_d: "The kings of Lydia made decisions about commerce that relegated their kingdom to a minor role in history.", correct_answer: answerKeys.reading[20], question_type: "inference", question_category: "KID"}
];

console.log('ðŸ“š EXTRACTING READING P2 (Q11-20)...');
const {data: passage, error: pErr} = await supabase.from('act_reading_passages').upsert({test_number: TEST_NUMBER, passage_number: 2, passage_type: "Social Science", title: "The History of Money", author: "Jack Weatherford", source: "Â©1997 by Jack McIver Weatherford", passage_text: PASSAGE_TEXT}, {onConflict: 'test_number,passage_number'}).select().single();
if (pErr) {console.error('Passage error:', pErr); process.exit(1);}
console.log('âœ… Passage uploaded');

let count = 0;
for (const q of questions) {
  const {error} = await supabase.from('act_reading_questions').upsert({test_number: TEST_NUMBER, question_number: q.question_number, passage_id: passage.id, question_stem: q.question_stem, choice_a: q.choice_a, choice_b: q.choice_b, choice_c: q.choice_c, choice_d: q.choice_d, correct_answer: q.correct_answer, question_type: q.question_type, question_category: q.question_category}, {onConflict: 'test_number,question_number'});
  if (!error) {count++; console.log(`âœ… Q${q.question_number} â†’ ${q.correct_answer}`);}
}
console.log(`\nðŸ“Š P2 Complete: ${count}/10`);
