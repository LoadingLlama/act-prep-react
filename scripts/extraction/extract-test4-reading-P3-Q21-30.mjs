#!/usr/bin/env node
import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import fs from 'fs';
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
dotenv.config({ path: join(__dirname, '../../.env') });
const supabase = createClient(process.env.REACT_APP_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
const TEST_NUMBER = 4;
const answerKeys = JSON.parse(fs.readFileSync(join(__dirname, '../../data/test4-answer-keys.json'), 'utf8'));

const PASSAGE_A_TEXT = `Even before I began using puppets in my performances in 1982, I had always felt connected to the Japanese Bunraku theatre. The structure of the Bunraku theatre as a series of three splits or fragments of the conventions of Western theatre (text, music, and puppet) seemed to me a new way to organize a performance. The puppet, along with the manipulator, was a separate entity, and so was the narrator, as was the musician (the latter two on a platform to one side). Bunraku presented a total, though divided, spectacle. One's focus could go back and forth between the manipulator or the puppet, the manipulation or the resulting gesture. Japanese puppet drama developed at a rapid pace in the 1700s. Male puppeteers were hidden from the public by a curtain while they held (one-man) puppets, about two feet tall, above their heads. The narrator and musician were also hidden. In 1703, a group of puppeteers created a sensation when they appeared in full view of the audience, separated only by a translucent curtain. The curtain itself was eliminated two years later. In 1728, the narrator and musician were given their own auxiliary stage, the yuka. Since then, one unusual feature of the Japanese puppet theatre is that the manipulator makes no attempt to conceal the fact that he is manipulating the puppets. Unlike puppet performances from other countries, this Japanese form does not require the illusion that the puppets are moving and talking on their own. In 1983, I began to use a modified Bunraku performance style for certain life-size human figures. I spent plenty of time trying to make them super-realistic, so that their skin looked lifelike, their eyes blinked "naturally," and their hands could actually grab objects. What I didn't understand then about Bunraku theatre was that its greatness lay in the constant tension, and the attempt to strike a balance between realism and nonrealism. Bunraku was not trying to persuade the audience it was watching reality, rather than a play. And I was very much interested in creating a flat surface of reality. Looking back, I feel that I was barely exploring the full potential of the Japanese form.`;

const PASSAGE_B_TEXT = `Japanese puppetry takes its great power from the fact that it is very realistic and very artificial at the same time. As was proved again by the Awaji Puppet Theatre Company's recent season at Japan Society, what strikes you first is the realism. The puppeteers seem to have spent five centuries (that is the genre's estimated age, at minimum) working out the precise rhythm with which a weeping woman would dab her eyes with her sleeve. The lifelikeness is indeed a thrill. But the reason that we can enjoy the realism is that in other respects, most respects, these figures are not at all like us. The Awaji puppets are about three feet tall, to start with. Furthermore, to get around, they need three men, with rods and springs, manipulating them. The puppeteers are clothed and masked in black, but that doesn't mean that we don't see them. All this, maybe, we could shut out, and enter fully into the illusion, but there is another thing stopping us: the fixity of the puppets' faces. Awaji dramas, like their Bunraku counterparts, often concern the furthest outdistricts of human emotion. In one of the offerings at Japan Society, "Hidakagawa Iriai Zakura" (1759), a woman becomes so jealous that she turns into a green sea monster. Such dramatic events are preceded by long, histrionic speeches, but, as the characters deliver their orations, their faces, eerily, do not move. The emotion is displaced from the face and thereby gains in subtlety and force. As for the characters' words, those, too, are displacedâ€”to a chanter. This person, considered the star of the puppetry team, sits to the side of the stage, where he tells the story and, when necessary, speaks the dialogue. The crux, however, is not the words but the singing. The chanter sobs; he gasps; he calls on Heaven to witness his grief. (And he does so in male and female, old and young, high-status and low-status voices.) When the woman in "Hidakagawa" describes her jealousy, the chanter runs the gamut of vocal expressiveness: head notes and belly notes, squeals and grunts, trills and runs without end. Meanwhile, the lady for whom he is speaking stands there with an unmoving face, white and lustrous, like a pearl. We seem, here, to get everything that art can give: the abstemious and the unleashed, the Gothic and the Baroque. The logic is not logical; it is lyrical, musical.`;

const questions = [
  {question_number: 21, question_stem: "The author of Passage A suggests that changes in Bunraku that occurred in the early 1700s led to which of the following effects?", choice_a: "They made Bunraku more popular in countries beyond Japan.", choice_b: "They differentiated Bunraku from the puppetry of other countries.", choice_c: "They created the illusion that Bunraku puppets moved and talked on their own.", choice_d: "They brought about a shift in the kinds of stories that were recounted in Bunraku theater.", correct_answer: answerKeys.reading[21], question_type: "inference", question_category: "KID"},
  {question_number: 22, question_stem: "One main function of the last paragraph of Passage A (lines 30-42) is to:", choice_a: "explain the author's perspective on the Japanese methods used to create puppets.", choice_b: "suggest that puppets are inevitably unrealistic in their appearance.", choice_c: "describe a shortcoming in the author's early understanding of Bunraku.", choice_d: "assert that the complexity of Bunraku comes from its depiction of a flat surface of reality.", correct_answer: answerKeys.reading[22], question_type: "purpose", question_category: "CS"},
  {question_number: 23, question_stem: "In Passage A, how does the author explain her interest in Bunraku?", choice_a: "She indicates that she had always felt a connection to Bunraku.", choice_b: "She suggests that her own experimentation with puppet performances led her to Bunraku.", choice_c: "She states that she had always appreciated the long history of Bunraku.", choice_d: "She describes how performances at Japan Society inspired her to explore Bunraku.", correct_answer: answerKeys.reading[23], question_type: "detail", question_category: "KID"},
  {question_number: 24, question_stem: "The author of Passage A identifies Bunraku theater as combining what three fragments of Western theater?", choice_a: "Puppet, manipulator, and musician", choice_b: "Music, auxiliary stage, and puppet", choice_c: "Narrator, puppet, and text", choice_d: "Text, music, and puppet", correct_answer: answerKeys.reading[24], question_type: "detail", question_category: "KID"},
  {question_number: 25, question_stem: "In Passage B, how does the statement that \"Awaji dramas, like their Bunraku counterparts, often concern the furthest outdistricts of human emotion\" (lines 61-63) figure into the author's discussion?", choice_a: "It provides a reason for the fixity of the puppets' faces.", choice_b: "It introduces a contrast to the description of the chanter's emotional performance.", choice_c: "It highlights the difference between Awaji dramas and Bunraku dramas.", choice_d: "It supports a claim about the effectiveness of the puppeteers' realism.", correct_answer: answerKeys.reading[25], question_type: "purpose", question_category: "CS"},
  {question_number: 26, question_stem: "It can reasonably be inferred from Passage B that the chanter is often considered the star of Awaji theater primarily because:", choice_a: "the chanter's vocal performance dominates the audience's attention.", choice_b: "the chanter performs multiple roles at the same time.", choice_c: "there is typically only one chanter performing in each drama.", choice_d: "the chanter is traditionally positioned at the center of the stage.", correct_answer: answerKeys.reading[26], question_type: "inference", question_category: "IKI"},
  {question_number: 27, question_stem: "In the first paragraph of Passage B (lines 43-58), the author provides the example of the weeping woman most likely to:", choice_a: "introduce the topic of extreme realism in Japanese puppetry.", choice_b: "provide evidence that Japanese puppet performances are designed to evoke sadness.", choice_c: "argue that Japanese puppetry has been refined over many centuries.", choice_d: "demonstrate that puppet performances require both realistic and artificial elements.", correct_answer: answerKeys.reading[27], question_type: "purpose", question_category: "CS"},
  {question_number: 28, question_stem: "Regarding the perspectives from which the passage authors write, the two passages are:", choice_a: "similar, in that both authors write as theater critics reviewing specific performances.", choice_b: "similar, in that both authors write as artists informed by personal experience.", choice_c: "different, in that the author of Passage A writes as a scholar, while the author of Passage B writes as a puppeteer.", choice_d: "different, in that the author of Passage A writes from recollection, while the author of Passage B writes while attending a performance.", correct_answer: answerKeys.reading[28], question_type: "comparison", question_category: "IKI"},
  {question_number: 29, question_stem: "Which of the following statements regarding the gender of the puppeteers in Japanese theater can most reasonably be inferred from the passages?", choice_a: "In the early history of Bunraku, all puppeteers were male, and today this remains true.", choice_b: "In the early history of Bunraku, all puppeteers were male, but today both men and women work as puppeteers.", choice_c: "In Bunraku, both men and women have always worked as puppeteers.", choice_d: "The passages do not provide enough information to make such an inference.", correct_answer: answerKeys.reading[29], question_type: "inference", question_category: "IKI"},
  {question_number: 30, question_stem: "The passages are similar in that both authors reach the conclusion that the form of Japanese puppetry they describe:", choice_a: "exhibits both realistic and artificial elements.", choice_b: "has been shaped by developments in the 1700s.", choice_c: "is indebted to centuries of artistic refinement.", choice_d: "requires the audience to suspend its disbelief.", correct_answer: answerKeys.reading[30], question_type: "comparison", question_category: "IKI"}
];

console.log('ðŸ“š EXTRACTING READING P3 (Q21-30) Bunraku Dual Passage...');
const passageText = `Passage A by Theodora Skipitares\n\n${PASSAGE_A_TEXT}\n\nPassage B by Joan Acocella\n\n${PASSAGE_B_TEXT}`;
const {data: passage, error: pErr} = await supabase.from('act_reading_passages').upsert({test_number: TEST_NUMBER, passage_number: 3, passage_type: "Humanities", title: "Japanese Bunraku Theatre", author: "Theodora Skipitares and Joan Acocella", source: "Dual Passage", passage_text: passageText}, {onConflict: 'test_number,passage_number'}).select().single();
if (pErr) {console.error('Passage error:', pErr); process.exit(1);}
console.log('âœ… Dual Passage uploaded');

let count = 0;
for (const q of questions) {
  const {error} = await supabase.from('act_reading_questions').upsert({test_number: TEST_NUMBER, question_number: q.question_number, passage_id: passage.id, question_stem: q.question_stem, choice_a: q.choice_a, choice_b: q.choice_b, choice_c: q.choice_c, choice_d: q.choice_d, correct_answer: q.correct_answer, question_type: q.question_type, question_category: q.question_category}, {onConflict: 'test_number,question_number'});
  if (!error) {count++; console.log(`âœ… Q${q.question_number} â†’ ${q.correct_answer}`);}
}
console.log(`\nðŸ“Š P3 Complete: ${count}/10`);
